<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü—É–±–ª–∏—á–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-button-color: #4d6073;
            --tg-theme-button-text-color: #ffffff;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #222222);
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-y: auto;
        }

        .content-container {
            flex-grow: 1;
            padding-bottom: 70px; /* –î–ª—è –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
            overflow-y: auto;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            color: #6c757d;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #7a9b8e;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .section {
            display: none;
            padding: 20px;
        }

        .section.active {
            display: block;
        }

        .page-title {
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #333);
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
            border: none;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å–µ–∫—Ü–∏–π */
        .empty-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #6c757d;
        }

        .empty-section i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-section h3 {
            margin-bottom: 10px;
            font-weight: 500;
        }

        .empty-section p {
            margin: 0;
            opacity: 0.7;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–Ω–µ–≤–Ω–∏–∫–∞ */
        .date-navigator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%);
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(122, 155, 142, 0.3);
        }

        .date-navigator button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        .date-navigator button:hover {
            background: rgba(255,255,255,0.3);
        }

        .date-navigator button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-navigator h3 {
            margin: 0;
            font-weight: 600;
            text-align: center;
            flex: 1;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–±—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
        .info-card {
            background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(122, 155, 142, 0.3);
        }

        .calories-circle {
            position: relative;
            width: 120px;
            height: 140px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calories-circle svg {
            transform: rotate(-90deg);
        }

        .calories-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .calories-number {
            font-size: 24px;
            font-weight: 700;
            line-height: 1;
        }

        .calories-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .macro-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .macro-item {
            text-align: left;
        }

        .macro-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .macro-progress {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .macro-progress-bar {
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .macro-text {
            font-size: 12px;
            opacity: 0.8;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ */
        .meals-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .meal-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--tg-theme-button-color, #4d6073);
        }

        .meal-time {
            font-weight: 600;
            color: var(--tg-theme-button-color, #4d6073);
            font-size: 0.9rem;
        }

        .meal-description {
            margin: 5px 0;
            color: #333;
            white-space: pre-line;
        }

        .meal-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .meal-image:hover {
            transform: scale(1.05);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 90%;
            max-width: 500px;
            max-height: 90%;
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #bbb;
        }

        /* –°—Ç–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6c757d;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 576px) {
            .section {
                padding: 15px;
            }
            
            .macro-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .calories-circle {
                width: 100px;
                height: 100px;
            }
            
            .calories-number {
                font-size: 20px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –í–µ—Å (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp) */
        .weight-card {
            background: linear-gradient(135deg, #7a9b8e 0%, #5a7b6e 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(122, 155, 142, 0.3);
        }

        .weight-current {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .weight-change {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weight-change.positive {
            color: #ff6b6b;
        }

        .weight-change.negative {
            color: #51cf66;
        }

        .weight-goal {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .period-selector {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .period-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 70px;
        }

        .period-btn.active {
            background: #7a9b8e;
            color: white;
            box-shadow: 0 2px 8px rgba(122, 155, 142, 0.3);
        }

        .weight-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: 300px;
            position: relative;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            flex-direction: column;
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .weight-history-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .weight-history-header {
            background: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .weight-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            font-weight: 500;
            color: #333;
        }

        .weight-entry-value {
            font-weight: 600;
            color: #7a9b8e;
        }

        .weight-entry-change {
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .weight-entry-change.positive {
            color: #ff6b6b;
        }

        .weight-entry-change.negative {
            color: #51cf66;
        }

        .weight-entry-delete {
            margin-left: 10px;
            background-color: #e9ecef;
            border: none;
            cursor: pointer;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            opacity: 0.8;
        }

        .weight-entry-delete:hover {
            background-color: #d8dfe3;
            opacity: 1;
        }

        .weight-entry-delete .fas.fa-times {
            font-size: 12px;
            color: #495057;
            line-height: 1;
        }
        .weight-card {
            background: linear-gradient(135deg, #7a9b8e 0%, #5a7b6e 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(122, 155, 142, 0.3);
        }

        .weight-current {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .weight-change {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weight-change.positive {
            color: #ff6b6b;
        }

        .weight-change.negative {
            color: #51cf66;
        }

        .weight-goal {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .period-selector {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .period-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .period-btn:hover {
            background: rgba(122, 155, 142, 0.1);
            color: #7a9b8e;
        }

        .period-btn.active {
            background: #7a9b8e;
            color: white;
        }

        .weight-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .weight-history-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .weight-history-header {
            background: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
        }

        .weight-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            font-weight: 500;
            color: #333;
        }

        .weight-entry-value {
            font-weight: 600;
            color: #7a9b8e;
            margin-right: 10px;
        }

        .weight-entry-change {
            font-size: 0.85rem;
            font-weight: 500;
            margin-right: 10px;
        }

        .weight-entry-change.positive {
            color: #ff6b6b;
        }

        .weight-entry-change.negative {
            color: #51cf66;
        }

        .weight-entry-delete {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .weight-entry-delete:hover {
            opacity: 1;
            background: rgba(220, 53, 69, 0.1);
        }
    </style>
</head>
<body>
    <div class="content-container">
        <!-- –°–µ–∫—Ü–∏—è –î–Ω–µ–≤–Ω–∏–∫ -->
        <div id="diary-section" class="section active">
            <h2 class="page-title">üìò –î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è</h2>
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º -->
            <div class="date-navigator">
                <button onclick="navigateDay(-1)">‚Äπ</button>
                <h3 id="currentDate">–°–µ–≥–æ–¥–Ω—è</h3>
                <button id="nextDayBtn" onclick="navigateDay(1)">‚Ä∫</button>
            </div>
            
            <div id="diary-content">
                <div id="loading" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–≤–Ω–∏–∫–∞...</p>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp) -->
        <div id="stats-section" class="section">
            <h2 class="page-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º -->
            <div class="date-navigator" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%); border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(122, 155, 142, 0.3);">
                <button onclick="navigateWeek(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    ‚Äπ
                </button>
                <h3 id="weekRange" style="margin: 0; font-weight: 600; text-align: center;">–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</h3>
                <button id="nextWeekBtn" onclick="navigateWeek(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    ‚Ä∫
                </button>
            </div>
            
            <div id="stats-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                </div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –í–µ—Å -->
        <div id="weight-section" class="section">
            <h2 class="page-title">‚öñÔ∏è –í–µ—Å</h2>
            <div id="weight-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="row text-center">
                <div class="col">
                    <a href="#diary" class="nav-item active" data-section="diary-section">
                        <div class="nav-icon">üìò</div>
                        <span>–î–Ω–µ–≤–Ω–∏–∫</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#stats" class="nav-item" data-section="stats-section">
                        <div class="nav-icon">üìä</div>
                        <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#weight" class="nav-item" data-section="weight-section">
                        <div class="nav-icon">‚öñÔ∏è</div>
                        <span>–í–µ—Å</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div id="imageModal" class="image-modal">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentDayOffset = 0;
        let currentWeekOffset = 0;
        let sharedData = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            setupNavigation();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            setupImageModal();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–Ω–µ–≤–Ω–∏–∫–∞
            loadSharedDiary();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    navItems.forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    this.classList.add('active');
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–µ–∫—Ü–∏–∏
                    if (sectionId === 'stats-section') {
                        loadStatsData();
                    } else if (sectionId === 'weight-section') {
                        loadWeightData();
                    }
                });
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function setupImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const span = document.getElementsByClassName('close')[0];

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            span.onclick = function() {
                modal.style.display = 'none';
            };

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

        // –ü–æ–∫–∞–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ bot.py)
        function calculateUserTargets(userInfo) {
            const { age, height, weight, goal, gender, activity, pregnant } = userInfo;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
            const userGender = gender || "–º—É–∂"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –º—É–∂—á–∏–Ω–∞
            const userActivity = activity || "—Å—Ä–µ–¥–Ω–∏–π"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
            const isPregnant = pregnant || false;
            
            // Calculate BMR (Mifflin-St Jeor) - —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –±–æ—Ç–∞
            let bmr;
            if (userGender === "–º—É–∂") {
                bmr = 10 * weight + 6.25 * height - 5 * age + 5;
            } else {
                bmr = 10 * weight + 6.25 * height - 5 * age - 161;
            }
            
            // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ - —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –±–æ—Ç–∞
            const multipliers = {"–Ω–∏–∑–∫–∏–π": 1.2, "—Å—Ä–µ–¥–Ω–∏–π": 1.3, "–≤—ã—Å–æ–∫–∏–π": 1.4};
            const maintenance = bmr * (multipliers[userActivity] || 1.2);
            
            // –†–∞—Å—á–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö –∫–∞–ª–æ—Ä–∏–π - —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –ª–æ–≥–∏–∫–∏ –∏–∑ –±–æ—Ç–∞
            let targetCalories;
            if (isPregnant) {
                if (goal === weight) {
                    targetCalories = maintenance * 1.17;
                } else if (goal < weight) {
                    targetCalories = maintenance;
                } else {
                    targetCalories = maintenance * 1.34;
                }
            } else {
                if (goal === weight) {
                    targetCalories = maintenance;
                } else if (goal < weight) {
                    targetCalories = maintenance * 0.83;
                } else {
                    targetCalories = maintenance * 1.17;
                }
            }
            
            // –ú–∏–Ω–∏–º—É–º 1200 –∫–∞–ª–æ—Ä–∏–π - –∫–∞–∫ –≤ –±–æ—Ç–µ
            targetCalories = Math.max(1200, targetCalories);
            
            // –†–∞—Å—á–µ—Ç –ë–ñ–£ - —Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –±–æ—Ç–∞
            const proteinGrams = Math.floor((targetCalories * 0.3) / 4);
            const fatGrams = Math.floor((targetCalories * 0.3) / 9);
            const carbsGrams = Math.floor((targetCalories * 0.4) / 4);
            const fiberGrams = Math.max(20, Math.round(targetCalories * 0.014));
            
            return {
                calories: Math.floor(targetCalories),
                protein: proteinGrams,
                fat: fatGrams,
                carb: carbsGrams,
                fiber: fiberGrams
            };
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–Ω—è–º (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ webapp)
        function navigateDay(direction) {
            // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –≤ –±—É–¥—É—â–µ–µ (direction = 1) –∫–æ–≥–¥–∞ —É–∂–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º –¥–Ω–µ
            if (direction === 1 && currentDayOffset === 0) {
                console.log('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –±—É–¥—É—â–µ–µ –∑–∞–ø—Ä–µ—â–µ–Ω');
                return;
            }
            
            currentDayOffset += direction;
            console.log('üîÑ –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –¥–µ–Ω—å —Å offset:', currentDayOffset);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–Ω—è (–¥–∞–Ω–Ω—ã–µ —É–∂–µ –µ—Å—Ç—å –≤ sharedData)
            loadDiaryForDay(currentDayOffset);
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º
        function navigateWeek(direction) {
            // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –≤ –±—É–¥—É—â–µ–µ (direction = 1) –∫–æ–≥–¥–∞ —É–∂–µ –Ω–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ
            if (direction === 1 && currentWeekOffset === 0) {
                console.log('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –±—É–¥—É—â–µ–µ –∑–∞–ø—Ä–µ—â–µ–Ω');
                return;
            }
            
            currentWeekOffset += direction;
            updateWeekDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏
        function updateWeekDisplay() {
            const weekRangeElement = document.getElementById('weekRange');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + 1 + (currentWeekOffset * 7)); // –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
            
            const formatDate = (date) => {
                return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
            };
            
            if (currentWeekOffset === 0) {
                weekRangeElement.textContent = '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è';
                nextWeekBtn.disabled = true;
                nextWeekBtn.style.opacity = '0.5';
            } else {
                weekRangeElement.textContent = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
                nextWeekBtn.disabled = false;
                nextWeekBtn.style.opacity = '1';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞
        async function loadSharedDiary() {
            console.log('üì• –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–Ω–µ–≤–Ω–∏–∫–∞...');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL
            const pathParts = window.location.pathname.split('/');
            console.log('üìç –¢–µ–∫—É—â–∏–π –ø—É—Ç—å:', window.location.pathname);
            
            const token = pathParts[pathParts.length - 1];
            console.log('üîë –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω:', token);
            
            if (!token || token === 'shared-diary') {
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–Ω–µ–≤–Ω–∏–∫</p>
                    </div>
                `;
                return;
            }
            
            try {
                const apiUrl = `https://telegram-bot-api-h136.onrender.com/shared-diary/${token}`;
                console.log('üåê –ó–∞–ø—Ä–æ—Å –∫ URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì° –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
                
                if (data.status === 'success') {
                    console.log('‚úÖ –°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω—ã–π, –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ renderDiary');
                    console.log('üìã –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', data.data);
                    console.log('üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ sharedData:', Object.keys(data.data));
                    console.log('üë§ user_info:', data.data.user_info);
                    console.log('üéØ user_targets:', data.data.user_targets);
                    console.log('üìä –í—Å–µ –ø–æ–ª—è –≤ data.data:', data.data);
                    sharedData = data.data;
                    loadDiaryForDay(currentDayOffset); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π offset –≤–º–µ—Å—Ç–æ 0
                } else {
                    throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–Ω–µ–≤–Ω–∏–∫. ${error.message}</p>
                    </div>
                `;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–≤–Ω–∏–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è
        function loadDiaryForDay(dayOffset) {
            if (!sharedData) {
                console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }

            console.log('üé® –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–Ω–µ–≤–Ω–∏–∫–∞ –¥–ª—è –¥–Ω—è:', dayOffset);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞—Ç—ã
            updateDateDisplay(dayOffset);
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –¥–Ω—è–º
            const today = new Date();
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + dayOffset);
            const targetDateStr = targetDate.toISOString().split('T')[0];
            
            console.log('üìÖ –¶–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞:', targetDateStr);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ)
            const dayEntries = sharedData?.meal_entries?.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                console.log('üîç –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∞—Ç—ã:', entryDate, 'vs', targetDateStr);
                return entryDate === targetDateStr;
            }) || [];
            
            console.log('üìù –ó–∞–ø–∏—Å–∏ –¥–ª—è –¥–Ω—è:', dayEntries);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è
            const dayData = {
                total_calories: 0,
                total_protein: 0,
                total_fat: 0,
                total_carb: 0,
                total_fiber: 0,
                meals: []
            };

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å
            dayEntries.forEach((entry, index) => {
                const time = new Date(entry.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let nutritionData = null;
                try {
                    nutritionData = typeof entry.response === 'string' ? JSON.parse(entry.response) : entry.response;
                } catch (e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON:', e);
                }

                let mealCalories = 0;
                let mealProtein = 0;
                let mealFat = 0;
                let mealCarb = 0;
                let mealFiber = 0;
                let mealItems = [];
                let description = '';

                console.log('–î–∞–Ω–Ω—ã–µ –æ –ø–∏—Ç–∞–Ω–∏–∏:', nutritionData);

                if (nutritionData && nutritionData.items) {
                    description = '–ù–∞ —Ñ–æ—Ç–æ:';
                    nutritionData.items.forEach(item => {
                        const calories = parseFloat(item.calories) || 0;
                        const protein = parseFloat(item.protein) || 0;
                        const fat = parseFloat(item.fat) || 0;
                        const carb = parseFloat(item.carb) || 0;
                        const fiber = parseFloat(item.fiber) || 0;
                        const weight = parseFloat(item.weight) || 0;

                        mealCalories += calories;
                        mealProtein += protein;
                        mealFat += fat;
                        mealCarb += carb;
                        mealFiber += fiber;

                        mealItems.push({
                            name: item.name || '–ü—Ä–æ–¥—É–∫—Ç',
                            weight: weight + '–≥',
                            calories: calories.toFixed(0) + ' –∫–∫–∞–ª'
                        });

                        description += '\n‚Ä¢ ' + (item.name || '–ü—Ä–æ–¥—É–∫—Ç') + ' ‚Äì ' + weight + ' –≥ (~' + calories.toFixed(0) + ' –∫–∫–∞–ª)';
                    });
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ response
                    let rawDescription = entry.prompt || entry.response || '–ó–∞–ø–∏—Å—å –æ –ø–∏—Ç–∞–Ω–∏–∏';
                    
                    // –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –∏—Ç–æ–≥–∞–º–∏ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
                    description = rawDescription.replace(/üìä\s*–ò—Ç–æ–≥–æ:.*$/gm, '').trim();
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∫–∞–ª–æ—Ä–∏–∏ –∏–∑ response –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (entry.response) {
                        const caloriesMatch = entry.response.match(/(\d+)\s*–∫–∫–∞–ª/i);
                        if (caloriesMatch) {
                            mealCalories = parseInt(caloriesMatch[1]);
                        }
                        
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –ë–ñ–£ –∏–∑ —Å—Ç—Ä–æ–∫–∏ "–ò—Ç–æ–≥–æ"
                        const totalMatch = entry.response.match(/–ò—Ç–æ–≥–æ:\s*(\d+)\s*–∫–∫–∞–ª.*?–ë–µ–ª–∫–∏:\s*([\d.]+)\s*–≥.*?–ñ–∏—Ä—ã:\s*([\d.]+)\s*–≥.*?–£–≥–ª–µ–≤–æ–¥—ã:\s*([\d.]+)\s*–≥.*?–ö–ª–µ—Ç—á–∞—Ç–∫–∞:\s*([\d.]+)\s*–≥/i);
                        if (totalMatch) {
                            mealCalories = parseInt(totalMatch[1]) || 0;
                            mealProtein = parseFloat(totalMatch[2]) || 0;
                            mealFat = parseFloat(totalMatch[3]) || 0;
                            mealCarb = parseFloat(totalMatch[4]) || 0;
                            mealFiber = parseFloat(totalMatch[5]) || 0;
                        }
                    }
                }

                console.log('–ö–∞–ª–æ—Ä–∏–∏ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏:', mealCalories);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫ –æ–±—â–∏–º –∏—Ç–æ–≥–∞–º
                dayData.total_calories += mealCalories;
                dayData.total_protein += mealProtein;
                dayData.total_fat += mealFat;
                dayData.total_carb += mealCarb;
                dayData.total_fiber += mealFiber;

                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏
                dayData.meals.push({
                    id: index + 1,
                    time: time,
                    description: description,
                    calories: mealCalories.toFixed(0),
                    protein: mealProtein.toFixed(1),
                    fat: mealFat.toFixed(1),
                    carb: mealCarb.toFixed(1),
                    image: entry.image, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ image –≤–º–µ—Å—Ç–æ compressed_image
                    items: mealItems,
                    timestamp: entry.timestamp
                });
            });

            // –û–∫—Ä—É–≥–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            dayData.total_calories = Math.round(dayData.total_calories);
            dayData.total_protein = Math.round(dayData.total_protein * 10) / 10;
            dayData.total_fat = Math.round(dayData.total_fat * 10) / 10;
            dayData.total_carb = Math.round(dayData.total_carb * 10) / 10;
            dayData.total_fiber = Math.round(dayData.total_fiber * 10) / 10;
            
            console.log('–ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–Ω—è:', dayData);
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            renderDiaryData(dayData);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã
        function updateDateDisplay(dayOffset) {
            const currentDateElement = document.getElementById('currentDate');
            const nextDayBtn = document.getElementById('nextDayBtn');
            
            const today = new Date();
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + dayOffset);
            
            if (dayOffset === 0) {
                currentDateElement.textContent = '–°–µ–≥–æ–¥–Ω—è';
                nextDayBtn.disabled = true;
                nextDayBtn.style.opacity = '0.5';
            } else if (dayOffset === -1) {
                currentDateElement.textContent = '–í—á–µ—Ä–∞';
                nextDayBtn.disabled = false;
                nextDayBtn.style.opacity = '1';
            } else {
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                currentDateElement.textContent = targetDate.toLocaleDateString('ru-RU', options);
                nextDayBtn.disabled = false;
                nextDayBtn.style.opacity = '1';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–Ω–µ–≤–Ω–∏–∫–∞ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ webapp)
        function renderDiaryData(data) {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º loading –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            const diaryContent = document.getElementById('diary-content');
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userTargets = calculateUserTargets(sharedData.user_info);
            console.log('üéØ –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:', userTargets);
            
            const targetCalories = userTargets.calories;
            const targetProtein = userTargets.protein;
            const targetFat = userTargets.fat;
            const targetCarb = userTargets.carb;
            const targetFiber = userTargets.fiber;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
            const caloriesPercent = Math.min((data.total_calories / targetCalories) * 100, 100);
            const proteinPercent = Math.min((data.total_protein / targetProtein) * 100, 100);
            const fatPercent = Math.min((data.total_fat / targetFat) * 100, 100);
            const carbPercent = Math.min((data.total_carb / targetCarb) * 100, 100);
            const fiberPercent = Math.min((data.total_fiber / targetFiber) * 100, 100);
            
            // –°–æ–∑–¥–∞–µ–º SVG –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–∞–ª–æ—Ä–∏–π
            const radius = 50;
            const circumference = 2 * Math.PI * radius;
            const strokeDasharray = circumference;
            const strokeDashoffset = circumference - (caloriesPercent / 100) * circumference;
            
            let html = `
                <div class="info-card">
                    <h5 class="mb-0">üìä –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    
                    <div class="calories-circle">
                        <div style="position: relative; display: inline-block;">
                            <svg width="120" height="120" style="transform: rotate(-90deg);">
                                <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="8"/>
                                <circle cx="60" cy="60" r="50" fill="none" stroke="white" stroke-width="8" 
                                        stroke-dasharray="${2 * Math.PI * 50}" 
                                        stroke-dashoffset="${2 * Math.PI * 50 * (1 - Math.min(caloriesPercent / 100, 1))}"
                                        style="transition: stroke-dashoffset 0.5s ease;"/>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                <div style="font-size: 1.2rem; font-weight: 700;">${data.total_calories}</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">–∏–∑ ${targetCalories}</div>
                                <div style="font-size: 0.7rem; opacity: 0.8;">–∫–∫–∞–ª</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="macro-grid">
                        <div class="macro-item">
                            <div class="macro-label">–ë–µ–ª–∫–∏: ${data.total_protein}–≥ / ${targetProtein}–≥</div>
                            <div class="macro-progress">
                                <div class="macro-progress-bar" style="width: ${proteinPercent}%"></div>
                            </div>
                            <div class="macro-text">${Math.round(proteinPercent)}%</div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">–ñ–∏—Ä—ã: ${data.total_fat}–≥ / ${targetFat}–≥</div>
                            <div class="macro-progress">
                                <div class="macro-progress-bar" style="width: ${fatPercent}%"></div>
                            </div>
                            <div class="macro-text">${Math.round(fatPercent)}%</div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">–£–≥–ª–µ–≤–æ–¥—ã: ${data.total_carb}–≥ / ${targetCarb}–≥</div>
                            <div class="macro-progress">
                                <div class="macro-progress-bar" style="width: ${carbPercent}%"></div>
                            </div>
                            <div class="macro-text">${Math.round(carbPercent)}%</div>
                        </div>
                        
                        <div class="macro-item">
                            <div class="macro-label">–ö–ª–µ—Ç—á–∞—Ç–∫–∞: ${data.total_fiber}–≥ / ${targetFiber}–≥</div>
                            <div class="macro-progress">
                                <div class="macro-progress-bar" style="width: ${fiberPercent}%"></div>
                            </div>
                            <div class="macro-text">${Math.round(fiberPercent)}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏
            if (data.meals && data.meals.length > 0) {
                let mealsHtml = `
                    <div class="meals-card">
                        <h5 class="mb-3">üçΩÔ∏è –ü—Ä–∏–µ–º—ã –ø–∏—â–∏</h5>
                `;
                
                data.meals.forEach(meal => {
                    let imageHtml = '';
                    if (meal.image) {
                        imageHtml = `
                            <img src="data:image/jpeg;base64,${meal.image}" 
                                 class="meal-image" 
                                 onclick="showImageModal('data:image/jpeg;base64,${meal.image}')"
                                 alt="–§–æ—Ç–æ –±–ª—é–¥–∞">
                        `;
                    } else {
                        imageHtml = `
                            <div style="width: 60px; height: 60px; background: #e9ecef; border-radius: 8px; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                                üçΩÔ∏è
                            </div>
                        `;
                    }
                    
                    mealsHtml += `
                        <div class="meal-item" style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--tg-theme-button-color, #4d6073);">
                            <div class="d-flex align-items-start">
                                ${imageHtml}
                                <div style="flex: 1;">
                                    <div class="meal-time" style="font-weight: 600; color: var(--tg-theme-button-color, #4d6073); font-size: 0.9rem;">${meal.time}</div>
                                    <div class="meal-description" style="margin: 5px 0; color: #333; white-space: pre-line;">${meal.description}</div>
                                    <div class="meal-calories" style="font-size: 0.9rem; color: #666;">
                                        ${meal.calories} –∫–∫–∞–ª ‚Ä¢ –ë: ${meal.protein}–≥ ‚Ä¢ –ñ: ${meal.fat}–≥ ‚Ä¢ –£: ${meal.carb}–≥
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                mealsHtml += `
                    </div>
                `;
                
                html += mealsHtml;
            } else {
                html += `
                    <div class="meals-card">
                        <div class="empty-section">
                            <i class="fas fa-utensils"></i>
                            <h3>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø–∏—Ç–∞–Ω–∏–∏</h3>
                            <p>–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
                        </div>
                    </div>
                `;
            }
            
            diaryContent.innerHTML = html;
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Chart.js
        let chartJSLoaded = false;
        let chartJSLoading = false;
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ Chart.js (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        async function loadChartJS() {
            // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
            if (chartJSLoaded || window.Chart) {
                chartJSLoaded = true;
                return true;
            }
            
            // –ï—Å–ª–∏ —É–∂–µ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞, –∂–¥–µ–º
            if (chartJSLoading) {
                return new Promise((resolve) => {
                    const checkLoaded = () => {
                        if (chartJSLoaded) {
                            resolve(true);
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                });
            }
            
            chartJSLoading = true;
            
            try {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.onload = () => {
                        chartJSLoaded = true;
                        chartJSLoading = false;
                        resolve();
                    };
                    script.onerror = () => {
                        chartJSLoading = false;
                        reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Chart.js'));
                    };
                    document.head.appendChild(script);
                });
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ Chart.js:', error);
                return false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        async function loadStatsData() {
            const statsContent = document.getElementById('stats-content');
            
            try {
                statsContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</p>
                    </div>
                `;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º Chart.js –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≥—Ä–∞—Ñ–∏–∫–æ–≤
                const chartLoaded = await loadChartJS();
                if (!chartLoaded) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
                statsContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
                    </div>
                `;
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                const userTargets = calculateUserTargets(sharedData.user_info);
                console.log('üìä –¶–µ–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', userTargets);
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç statsData –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞
                const statsData = {
                    user_targets: userTargets
                };
                
                await renderStatsWithCharts(statsData);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                statsContent.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadStatsData()">
                            <i class="fas fa-sync-alt"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                        </button>
                    </div>
                `;
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞—Ç –Ω–µ–¥–µ–ª–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ index.html)
        function generateWeekDates(weekOffset = 0) {
            const dates = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i + (weekOffset * 7));
                dates.push(date);
            }
            
            return dates;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ index.html)
        async function generateWeekData(weekDates, statsData, userId) {
            const weekData = {
                calories: [],
                proteins: [],
                fats: [],
                carbs: [],
                fiber: [],
                labels: []
            };
            
            for (const date of weekDates) {
                const dateStr = date.toISOString().split('T')[0];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
                const dayEntries = sharedData?.meal_entries?.filter(entry => {
                    const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                    return entryDate === dateStr;
                }) || [];
                
                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ö–ë–ñ–£ –∑–∞ –¥–µ–Ω—å
                let dayCalories = 0, dayProteins = 0, dayFats = 0, dayCarbs = 0, dayFiber = 0;
                
                dayEntries.forEach(entry => {
                    try {
                        const nutritionData = typeof entry.response === 'string' ? JSON.parse(entry.response) : entry.response;
                        if (nutritionData && nutritionData.items) {
                            nutritionData.items.forEach(item => {
                                dayCalories += parseFloat(item.calories) || 0;
                                dayProteins += parseFloat(item.protein) || 0;
                                dayFats += parseFloat(item.fat) || 0;
                                dayCarbs += parseFloat(item.carbohydrates) || 0;
                                dayFiber += parseFloat(item.fiber) || 0;
                            });
                        }
                    } catch (e) {
                        // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ —Å—Ç—Ä–æ–∫–∏ "–ò—Ç–æ–≥–æ"
                        if (entry.response) {
                            const totalMatch = entry.response.match(/–ò—Ç–æ–≥–æ:\s*(\d+)\s*–∫–∫–∞–ª.*?–ë–µ–ª–∫–∏:\s*(\d+)\s*–≥.*?–ñ–∏—Ä—ã:\s*(\d+)\s*–≥.*?–£–≥–ª–µ–≤–æ–¥—ã:\s*(\d+)\s*–≥/i);
                            if (totalMatch) {
                                dayCalories += parseInt(totalMatch[1]) || 0;
                                dayProteins += parseInt(totalMatch[2]) || 0;
                                dayFats += parseInt(totalMatch[3]) || 0;
                                dayCarbs += parseInt(totalMatch[4]) || 0;
                            }
                        }
                    }
                });
                
                weekData.calories.push(Math.round(dayCalories));
                weekData.proteins.push(Math.round(dayProteins));
                weekData.fats.push(Math.round(dayFats));
                weekData.carbs.push(Math.round(dayCarbs));
                weekData.fiber.push(Math.round(dayFiber));
                weekData.labels.push(date.toLocaleDateString('ru-RU', { weekday: 'short' }));
            }
            
            return weekData;
        }

        // –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ index.html)
        function createCaloriesChart(data, labels, target) {
            const ctx = document.getElementById('caloriesChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(value => {
                            const ratio = value / target;
                            if (ratio >= 1) {
                                return 'linear-gradient(180deg, #FFD700 0%, #7a9b8e 100%)';
                            } else {
                                return '#7a9b8e';
                            }
                        }),
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function createProteinsChart(data, labels, target) {
            const ctx = document.getElementById('proteinsChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: data.map(value => {
                            const ratio = value / target;
                            if (ratio >= 1) {
                                return 'linear-gradient(180deg, #FFD700 0%, #7a9b8e 100%)';
                            } else {
                                return '#7a9b8e';
                            }
                        }),
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ index.htm        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –Ω–µ–¥–µ–ª—è–º (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        function navigateWeek(direction) {
            currentWeekOffset += direction;
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ –±—É–¥—É—â–µ–µ
            if (currentWeekOffset > 0) {
                currentWeekOffset = 0;
                return;
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–∏
            loadStatsData();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        function updateWeekDisplay() {
            const weekRange = document.getElementById('weekRange');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            if (!weekRange) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ –≤ generateWeekDates
            const endDate = new Date(); // –°–µ–≥–æ–¥–Ω—è - —ç—Ç–æ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞
            endDate.setDate(endDate.getDate() + (currentWeekOffset * 7));
            
            const startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - 6); // 6 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –æ—Ç –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã
            
            const formatDate = (date) => {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            };
            
            if (currentWeekOffset === 0) {
                weekRange.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π';
            } else {
                weekRange.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            }
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "—Å–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è"
            if (nextWeekBtn) {
                if (currentWeekOffset === 0) {
                    // –ù–∞ —Ç–µ–∫—É—â–µ–º –ø–µ—Ä–∏–æ–¥–µ - –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
                    nextWeekBtn.style.background = 'rgba(150,150,150,0.4)';
                    nextWeekBtn.style.color = 'rgba(255,255,255,0.6)';
                    nextWeekBtn.style.cursor = 'not-allowed';
                    nextWeekBtn.disabled = true;
                } else {
                    // –ù–∞ –ø—Ä–æ—à–ª—ã—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö - –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    nextWeekBtn.style.background = 'rgba(255,255,255,0.2)';
                    nextWeekBtn.style.color = 'white';
                    nextWeekBtn.style.cursor = 'pointer';
                    nextWeekBtn.disabled = false;
                }
            }
            
            console.log(`–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å—å –Ω–µ–¥–µ–ª–∏ (offset=${currentWeekOffset}): ${weekRange.textContent}`);
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Chart.js
        let chartsLoaded = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ Chart.js
        function loadChartJS() {
            return new Promise((resolve) => {
                if (window.Chart) {
                    resolve(true);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = () => resolve(true);
                script.onerror = () => resolve(false);
                document.head.appendChild(script);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        async function renderStatsWithCharts(statsData) {
            const statsContent = document.getElementById('stats-content');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–Ω–µ–≤–Ω–∏–∫–∞
            const weekDates = generateWeekDates(currentWeekOffset);
            const weekData = await generateWeekData(weekDates, statsData, null);
            
            statsContent.innerHTML = `
                <style>
                .macro-card {
                    background-color: #fff;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    padding: 20px 0;
                    margin: 20px -20px;
                    border: 1px solid rgba(0, 0, 0, 0.05);
                }
                .macro-card h3 {
                    color: #333;
                    margin-bottom: 15px;
                    font-weight: 600;
                    font-size: 1.2rem;
                    padding: 0 20px;
                }
                .macro-card p {
                    color: #666;
                    margin-bottom: 15px;
                    font-size: 0.9rem;
                    padding: 0 20px;
                }
                .macro-card canvas {
                    height: 200px !important;
                    width: 100% !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
                </style>
                
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ -->
                <div class="macro-card">
                    <h3>–ö–∞–ª–æ—Ä–∏–∏ üî• <small style="font-size: 13px;">–¶–µ–ª—å: ${statsData.user_targets?.calories || 2000} –∫–∫–∞–ª</small></h3>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–µ–Ω—å: <strong>${Math.round(weekData.calories.reduce((a, b) => a + b, 0) / 7)} –∫–∫–∞–ª</strong></p>
                    <canvas id="caloriesChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>–ë–µ–ª–∫–∏ üí™ <small style="font-size: 13px;">–¶–µ–ª—å: ${statsData.user_targets?.protein || 100} –≥.</small></h3>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–µ–Ω—å: <strong>${Math.round(weekData.proteins.reduce((a, b) => a + b, 0) / 7)} –≥</strong></p>
                    <canvas id="proteinsChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>–ñ–∏—Ä—ã üßà <small style="font-size: 13px;">–¶–µ–ª—å: ${statsData.user_targets?.fat || 67} –≥.</small></h3>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–µ–Ω—å: <strong>${Math.round(weekData.fats.reduce((a, b) => a + b, 0) / 7)} –≥</strong></p>
                    <canvas id="fatsChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>–£–≥–ª–µ–≤–æ–¥—ã üçû <small style="font-size: 13px;">–¶–µ–ª—å: ${statsData.user_targets?.carb || 250} –≥.</small></h3>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–µ–Ω—å: <strong>${Math.round(weekData.carbs.reduce((a, b) => a + b, 0) / 7)} –≥</strong></p>
                    <canvas id="carbsChart"></canvas>
                </div>

                <div class="macro-card" style="margin-bottom: 30px;">
                    <h3>–ö–ª–µ—Ç—á–∞—Ç–∫–∞ üåæ <small style="font-size: 13px;">–¶–µ–ª—å: ${statsData.user_targets?.fiber || 25} –≥</small></h3>
                    <p>–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥–µ–Ω—å: <strong>${Math.round(weekData.fiber.reduce((a, b) => a + b, 0) / 7)} –≥</strong></p>    
                    <canvas id="fiberChart"></canvas>
                </div>
            `;
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
            setTimeout(() => {
                createCharts(weekDates, weekData, statsData.user_targets);
                updateWeekDisplay();
            }, 100);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞—Ç –Ω–µ–¥–µ–ª–∏ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        function generateWeekDates(weekOffset) {
            const dates = [];
            const endDate = new Date(); // –°–µ–≥–æ–¥–Ω—è - —ç—Ç–æ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞
            
            // –°–¥–≤–∏–≥–∞–µ–º –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É –Ω–∞ weekOffset * 7 –¥–Ω–µ–π
            endDate.setDate(endDate.getDate() + (weekOffset * 7));
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –æ—Ç –∫–æ–Ω–µ—á–Ω–æ–π –¥–∞—Ç—ã
            for (let i = 6; i >= 0; i--) {
                const date = new Date(endDate);
                date.setDate(endDate.getDate() - i);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å daily_data
                dates.push(date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }));
            }
            
            console.log(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã (—Å–∫–æ–ª—å–∑—è—â–∏–µ 7 –¥–Ω–µ–π, offset=${weekOffset}):`, dates);
            return dates;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–Ω–µ–≤–Ω–∏–∫–∞)
        async function generateWeekData(dates, statsData, userId) {
            console.log('üîç generateWeekData –≤—ã–∑–≤–∞–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', { dates, statsData, userId });
            console.log('üîç sharedData –¥–æ—Å—Ç—É–ø–µ–Ω:', !!sharedData);
            console.log('üîç sharedData.meal_entries:', sharedData?.meal_entries?.length || 0);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø–∏—Å–µ–π
            if (sharedData && sharedData.meal_entries && sharedData.meal_entries.length > 0) {
                console.log('üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏ meal_entries:');
                console.log(sharedData.meal_entries[0]);
                console.log('üìã –í—Å–µ –∫–ª—é—á–∏ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏:', Object.keys(sharedData.meal_entries[0]));
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–∫—Ä–æ–Ω—É—Ç—Ä–∏–µ–Ω—Ç–∞
            const calories = [];
            const proteins = [];
            const fats = [];
            const carbs = [];
            const fiber = [];
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–Ω–µ–≤–Ω–∏–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if (sharedData && sharedData.meal_entries) {
                console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ sharedData');
                
                for (const dateStr of dates) {
                    console.log(`üìÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É: ${dateStr}`);
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    const [day, month, year] = dateStr.split('.');
                    const targetDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    console.log(`üéØ –ò—â–µ–º –∑–∞–ø–∏—Å–∏ –∑–∞ –¥–∞—Ç—É: ${targetDate}`);
                    
                    // –ò—â–µ–º –∑–∞–ø–∏—Å–∏ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è —Å –¥–∞—Ç–æ–π
                    const dayEntries = sharedData.meal_entries.filter(entry => {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ–ª—è —Å –¥–∞—Ç–æ–π
                        const possibleDates = [
                            entry.date,
                            entry.created_at?.split('T')[0],
                            entry.timestamp?.split('T')[0],
                            entry.entry_date,
                            entry.meal_date
                        ];
                        
                        console.log(`  –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–∏—Å—å —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏:`, possibleDates);
                        
                        for (const possibleDate of possibleDates) {
                            if (possibleDate === targetDate) {
                                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${possibleDate} === ${targetDate}`);
                                return true;
                            }
                        }
                        
                        return false;
                    });
                    
                    console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –∑–∞ ${targetDate}: ${dayEntries.length}`);
                    
                    // –°—É–º–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ –¥–µ–Ω—å
                    let dayCalories = 0;
                    let dayProteins = 0;
                    let dayFats = 0;
                    let dayCarbs = 0;
                    let dayFiber = 0;
                    
                    dayEntries.forEach((entry, index) => {
                        console.log(`üçΩÔ∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–ø–∏—Å—å ${index + 1}:`, entry);
                        
                        // –î–∞–Ω–Ω—ã–µ –æ –ø–∏—Ç–∞–Ω–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–æ–ª–µ data, –∞ –Ω–µ nutrition_data
                        if (entry.data && Array.isArray(entry.data)) {
                            console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${entry.data.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ data`);
                            
                            entry.data.forEach((item, itemIndex) => {
                                console.log(`  ü•ó –≠–ª–µ–º–µ–Ω—Ç ${itemIndex + 1}:`, item);
                                console.log(`  üîç –í—Å–µ –∫–ª—é—á–∏ —ç–ª–µ–º–µ–Ω—Ç–∞:`, Object.keys(item || {}));
                                
                                if (item && typeof item === 'object') {
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–ª–æ—Ä–∏–π
                                    const possibleCaloriesFields = ['calories', 'kcal', 'energy', 'cal'];
                                    let itemCalories = 0;
                                    
                                    for (const field of possibleCaloriesFields) {
                                        if (item[field] !== undefined) {
                                            itemCalories = item[field];
                                            console.log(`  üî• –ù–∞–π–¥–µ–Ω—ã –∫–∞–ª–æ—Ä–∏–∏ –≤ –ø–æ–ª–µ "${field}": ${itemCalories}`);
                                            break;
                                        }
                                    }
                                    
                                    dayCalories += itemCalories || 0;
                                    dayProteins += item.protein || 0;
                                    dayFats += item.fat || 0;
                                    dayCarbs += item.carb || 0;
                                    dayFiber += item.fiber || 0;
                                    
                                    console.log(`  ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ: –∫–∞–ª–æ—Ä–∏–∏=${itemCalories}, –±–µ–ª–∫–∏=${item.protein}, –∂–∏—Ä—ã=${item.fat}, —É–≥–ª–µ–≤–æ–¥—ã=${item.carb}, –∫–ª–µ—Ç—á–∞—Ç–∫–∞=${item.fiber}`);
                                }
                            });
                        } else if (entry.nutrition_data) {
                            // Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                            try {
                                const nutrition = typeof entry.nutrition_data === 'string' 
                                    ? JSON.parse(entry.nutrition_data) 
                                    : entry.nutrition_data;
                                
                                console.log(`ü•ó Nutrition –¥–∞–Ω–Ω—ã–µ (fallback):`, nutrition);
                                
                                dayCalories += nutrition.calories || 0;
                                dayProteins += nutrition.protein || 0;
                                dayFats += nutrition.fat || 0;
                                dayCarbs += nutrition.carb || 0;
                                dayFiber += nutrition.fiber || 0;
                                
                                console.log(`‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ (fallback): –∫–∞–ª–æ—Ä–∏–∏=${nutrition.calories}, –±–µ–ª–∫–∏=${nutrition.protein}, –∂–∏—Ä—ã=${nutrition.fat}, —É–≥–ª–µ–≤–æ–¥—ã=${nutrition.carb}, –∫–ª–µ—Ç—á–∞—Ç–∫–∞=${nutrition.fiber}`);
                            } catch (e) {
                                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ nutrition_data:', e);
                            }
                        } else {
                            console.log('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–∏—Ç–∞–Ω–∏–∏ –≤ –∑–∞–ø–∏—Å–∏');
                        }
                    });
                    
                    console.log(`üìà –ò—Ç–æ–≥–æ –∑–∞ ${targetDate}: –∫–∞–ª–æ—Ä–∏–∏=${dayCalories}, –±–µ–ª–∫–∏=${dayProteins}, –∂–∏—Ä—ã=${dayFats}, —É–≥–ª–µ–≤–æ–¥—ã=${dayCarbs}, –∫–ª–µ—Ç—á–∞—Ç–∫–∞=${dayFiber}`);
                    
                    calories.push(Math.round(dayCalories));
                    proteins.push(Math.round(dayProteins));
                    fats.push(Math.round(dayFats));
                    carbs.push(Math.round(dayCarbs));
                    fiber.push(Math.round(dayFiber));
                }
            } else {
                console.log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö sharedData, –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω—É–ª—è–º–∏');
                // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω—É–ª—è–º–∏
                for (let i = 0; i < 7; i++) {
                    calories.push(0);
                    proteins.push(0);
                    fats.push(0);
                    carbs.push(0);
                    fiber.push(0);
                }
            }
            
            const result = {
                calories: calories,
                proteins: proteins,
                fats: fats,
                carbs: carbs,
                fiber: fiber
            };
            
            console.log('üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç generateWeekData:', result);
            return result;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ (—Ç–æ—á–Ω–∞—è –∫–æ–ø–∏—è –∏–∑ webapp)
        function createCharts(dates, data, targets) {
            console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            console.log('üéØ –î–∞—Ç—ã:', dates);
            console.log('üéØ –î–∞–Ω–Ω—ã–µ:', data);
            console.log('üéØ –¶–µ–ª–∏:', targets);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Chart.js –∑–∞–≥—Ä—É–∂–µ–Ω
            if (!window.Chart) {
                console.error('‚ùå Chart.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω! –ì—Ä–∞—Ñ–∏–∫–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã.');
                return;
            }
            
            console.log('‚úÖ Chart.js –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ Chart.js –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —à—Ä–∏—Ñ—Ç–æ–≤
            Chart.defaults.font.family = 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
            Chart.defaults.font.weight = '400';
            Chart.defaults.font.lineHeight = 1.2;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
            const dayNames = ['–í—Å', '–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];
            const weekDays = dates.map(dateStr => {
                // –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY
                const [day, month, year] = dateStr.split('.');
                const date = new Date(year, month - 1, day);
                return dayNames[date.getDay()];
            });
            
            console.log('üìÖ –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–µ–π:', weekDays);
            
            const config = [
                {
                    element: 'caloriesChart',
                    data: data.calories,
                    targetValue: targets?.calories || 2000,
                    icon: 'üî•'
                },
                {
                    element: 'proteinsChart',
                    data: data.proteins,
                    targetValue: targets?.protein || 100,
                    icon: 'üí™'
                },
                {
                    element: 'fatsChart',
                    data: data.fats,
                    targetValue: targets?.fat || 67,
                    icon: 'üßà'
                },
                {
                    element: 'carbsChart',
                    data: data.carbs,
                    targetValue: targets?.carb || 250,
                    icon: 'üçû'
                },
                {
                    element: 'fiberChart',
                    data: data.fiber,
                    targetValue: targets?.fiber || 25,
                    icon: 'üåæ'
                }
            ];

            console.log('üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤:', config);

            config.forEach(function(chartConfig, index) {
                console.log(`üìà –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ ${index + 1}/5: ${chartConfig.element}`);
                
                const ctx = document.getElementById(chartConfig.element);
                if (!ctx) {
                    console.error(`‚ùå –≠–ª–µ–º–µ–Ω—Ç ${chartConfig.element} –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                    return;
                }
                
                console.log(`‚úÖ –≠–ª–µ–º–µ–Ω—Ç ${chartConfig.element} –Ω–∞–π–¥–µ–Ω:`, ctx);
                
                const canvasCtx = ctx.getContext('2d');
                console.log(`‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç canvas –ø–æ–ª—É—á–µ–Ω:`, canvasCtx);
                
                // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
                const backgroundColors = chartConfig.data.map((value, index) => {
                    const percentage = (value / chartConfig.targetValue) * 100;
                    
                    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–æ—Ç –≤–µ—Ä—Ö–∞ –∫ –Ω–∏–∑—É)
                    const gradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                    
                    if (percentage <= 85) {
                        // –°–ª—É—á–∞–π 1: –î–æ 85% - –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–µ–ª–µ–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü
                        gradient.addColorStop(0, '#7a9b8e');
                        gradient.addColorStop(1, '#7a9b8e');
                        
                    } else if (percentage <= 100) {
                        // –°–ª—É—á–∞–π 2: 85-100% - –∑–µ–ª–µ–Ω—ã–π —Å–Ω–∏–∑—É, –∂–µ–ª—Ç—ã–π —Å–≤–µ—Ä—Ö—É
                        gradient.addColorStop(0, '#F1C40F');      // –í–µ—Ä—Ö - –∂–µ–ª—Ç—ã–π
                        gradient.addColorStop(0.2, '#F1C40F');    // 20% –∂–µ–ª—Ç–æ–≥–æ —Å–≤–µ—Ä—Ö—É
                        gradient.addColorStop(0.3, '#7a9b8e');    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–µ–ª–µ–Ω–æ–º—É
                        gradient.addColorStop(1, '#7a9b8e');      // 70% –∑–µ–ª–µ–Ω–æ–≥–æ —Å–Ω–∏–∑—É
                        
                    } else {
                        // –°–ª—É—á–∞–π 3: –í—ã—à–µ 100% - –∫—Ä–∞—Å–Ω—ã–π —Å–≤–µ—Ä—Ö—É, –∂–µ–ª—Ç—ã–π –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ, –∑–µ–ª–µ–Ω—ã–π —Å–Ω–∏–∑—É
                        const greenPortion = 85 / percentage;    // –î–æ–ª—è –∑–µ–ª–µ–Ω–æ–≥–æ (–¥–æ 85%)
                        const yellowPortion = 15 / percentage;   // –î–æ–ª—è –∂–µ–ª—Ç–æ–≥–æ (85-100%)
                        
                        gradient.addColorStop(0, '#E74C3C');                           // –í–µ—Ä—Ö - –∫—Ä–∞—Å–Ω—ã–π
                        gradient.addColorStop(1 - greenPortion - yellowPortion, '#E74C3C'); // –ö—Ä–∞—Å–Ω–∞—è –∑–æ–Ω–∞
                        gradient.addColorStop(1 - greenPortion - yellowPortion + 0.05, '#F1C40F'); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∂–µ–ª—Ç–æ–º—É
                        gradient.addColorStop(1 - greenPortion, '#F1C40F');            // –ñ–µ–ª—Ç–∞—è –∑–æ–Ω–∞
                        gradient.addColorStop(1 - greenPortion + 0.05, '#7a9b8e');     // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∑–µ–ª–µ–Ω–æ–º—É
                        gradient.addColorStop(1, '#7a9b8e');                          // –ó–µ–ª–µ–Ω–∞—è –∑–æ–Ω–∞
                    }
                    
                    return gradient;
                });
                
                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å —Ü–µ–ª–µ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
                const targetLine = new Array(weekDays.length).fill(chartConfig.targetValue);
                
                console.log(`üìä –°–æ–∑–¥–∞–µ–º Chart –¥–ª—è ${chartConfig.element}...`);
                
                try {
                    new Chart(canvasCtx, {
                        type: 'bar',
                        data: {
                            labels: weekDays,
                            datasets: [
                                {
                                    type: 'bar',
                                    label: '–î–∞–Ω–Ω—ã–µ',
                                    data: chartConfig.data,
                                    backgroundColor: backgroundColors,
                                    borderColor: 'transparent',
                                    borderWidth: 0,
                                    borderRadius: 4,
                                    borderSkipped: false,
                                    barThickness: 16,
                                    categoryPercentage: 1.0,
                                    barPercentage: 0.6
                                },
                                {
                                    type: 'line',
                                    label: '–¶–µ–ª—å',
                                    data: targetLine,
                                    borderColor: '#98989D',
                                    backgroundColor: 'transparent',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    pointHoverRadius: 0,
                                    fill: false,
                                    tension: 0,
                                    borderDash: [6, 6]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            animation: {
                                duration: 750,
                                easing: 'easeInOutQuart'
                            },
                            layout: {
                                padding: {
                                    top: 10,
                                    bottom: 5,
                                    left: 0,
                                    right: 0
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: true,
                                        drawBorder: false,
                                        color: 'rgba(152, 152, 157, 0.3)',
                                        borderDash: [2, 2],
                                        lineWidth: 1
                                    },
                                    border: {
                                        display: false
                                    },
                                    ticks: {
                                        color: '#8E8E93',
                                        font: {
                                            size: window.innerWidth < 768 ? 14 : 16,
                                            weight: '400',
                                            family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                        },
                                        maxRotation: 0,
                                        padding: 15,
                                        textStrokeColor: 'transparent',
                                        textStrokeWidth: 0
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    position: 'right',
                                    border: {
                                        display: false
                                    },
                                    grid: {
                                        color: 'rgba(152, 152, 157, 0.2)',
                                        borderDash: [],
                                        lineWidth: 1,
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: '#8E8E93',
                                        font: {
                                            size: window.innerWidth < 768 ? 13 : 15,
                                            weight: '400',
                                            family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                        },
                                        padding: 15,
                                        maxTicksLimit: 4,
                                        textStrokeColor: 'transparent',
                                        textStrokeWidth: 0,
                                        callback: function(value) {
                                            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞ –∫–∞–∫ –≤ Apple (—Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ç—ã—Å—è—á)
                                            return Math.round(value).toLocaleString('ru-RU');
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: 'rgba(28, 28, 30, 0.95)',
                                    titleColor: '#FFFFFF',
                                    bodyColor: '#FFFFFF',
                                    borderColor: 'transparent',
                                    borderWidth: 0,
                                    cornerRadius: 16,
                                    displayColors: false,
                                    titleFont: {
                                        size: window.innerWidth < 768 ? 15 : 17,
                                        weight: '500',
                                        family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                    },
                                    bodyFont: {
                                        size: window.innerWidth < 768 ? 14 : 16,
                                        weight: '400',
                                        family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                    },
                                    padding: 20,
                                    caretSize: 10,
                                    callbacks: {
                                        title: function(context) {
                                            return `${chartConfig.icon} ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            if (context.datasetIndex === 0) {
                                                const percentage = Math.round((context.parsed.y / chartConfig.targetValue) * 100);
                                                return `${context.parsed.y} (${percentage}% –æ—Ç —Ü–µ–ª–∏)`;
                                            } else {
                                                return `–¶–µ–ª—å: ${context.parsed.y}`;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    console.log(`‚úÖ –ì—Ä–∞—Ñ–∏–∫ ${chartConfig.element} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`);
                    
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ ${chartConfig.element}:`, error);
                }
            });
            
            console.log('üéØ –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ
        async function loadWeightData() {
            console.log('‚öñÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ...');
            console.log('üîç DEBUG: sharedData =', sharedData);
            
            const weightContent = document.getElementById('weight-content');
            if (!weightContent) {
                console.log('‚ùå DEBUG: –≠–ª–µ–º–µ–Ω—Ç weight-content –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∂–¥–µ–º –∏ –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
            if (!sharedData) {
                console.log('‚è≥ DEBUG: –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∂–¥–µ–º...');
                weightContent.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ...</div>';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100–º—Å –¥–æ 5 —Å–µ–∫—É–Ω–¥
                let attempts = 0;
                const maxAttempts = 50;
                const checkData = () => {
                    attempts++;
                    console.log(`üîÑ DEBUG: –ü–æ–ø—ã—Ç–∫–∞ ${attempts}/${maxAttempts}, sharedData =`, sharedData);
                    
                    if (sharedData) {
                        console.log('‚úÖ DEBUG: –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º...');
                        loadWeightData(); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º —Å–µ–±—è –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(checkData, 100);
                    } else {
                        console.log('‚ùå DEBUG: –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
                        weightContent.innerHTML = '<div class="text-center text-muted py-5">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ</div>';
                    }
                };
                
                setTimeout(checkData, 100);
                return;
            }

            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL –¥–ª—è API –∑–∞–ø—Ä–æ—Å–∞
                const pathParts = window.location.pathname.split('/');
                const token = pathParts[pathParts.length - 1];
                
                console.log('üîç DEBUG: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ —á–µ—Ä–µ–∑ API...');
                console.log('üîë DEBUG: –¢–æ–∫–µ–Ω –¥–ª—è API:', token);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                weightContent.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-spinner fa-spin me-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ...</div>';
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ —á–µ—Ä–µ–∑ API (–∫–∞–∫ –≤ webapp)
                const weightResponse = await fetch(`https://telegram-bot-api-h136.onrender.com/weight/${token}?period=month`);
                console.log('üì° DEBUG: –û—Ç–≤–µ—Ç API –≤–µ—Å–∞, —Å—Ç–∞—Ç—É—Å:', weightResponse.status);
                
                if (!weightResponse.ok) {
                    throw new Error(`HTTP ${weightResponse.status}`);
                }
                
                const weightData = await weightResponse.json();
                console.log('üìä DEBUG: –î–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ –∏–∑ API:', weightData);
                
                if (weightData.status === 'success') {
                    renderWeightData(weightData.data);
                } else {
                    throw new Error(weightData.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ');
                }
                
            } catch (error) {
                console.error('‚ùå DEBUG: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ:', error);
                
                // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                console.log('üîÑ DEBUG: –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback - –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è...');
                showWeightFromProfile();
            }
        }

        // Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤–µ—Å–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showWeightFromProfile() {
            console.log('üìä DEBUG: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            
            const weightContent = document.getElementById('weight-content');
            if (!weightContent) {
                console.log('‚ùå DEBUG: –≠–ª–µ–º–µ–Ω—Ç weight-content –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            const userInfo = sharedData.user_info || {};
            console.log('üë§ DEBUG: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è:', userInfo);

            // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è
            const profileWeightData = {
                entries: [], // –ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –≤–µ—Å
                current_weight: userInfo.weight,
                goal_weight: userInfo.goal,
                weight_change: null // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            };

            console.log('üìä DEBUG: –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è:', profileWeightData);
            renderWeightData(profileWeightData);
        }

        // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≤–µ—Å–µ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–∑ webapp)
        function renderWeightData(data) {
            console.log('üìä DEBUG: –†–µ–Ω–¥–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –æ –≤–µ—Å–µ:', data);
            
            const weightContent = document.getElementById('weight-content');
            const entries = data.entries || [];
            const currentWeight = data.current_weight;
            const goalWeight = data.goal_weight;
            const weightChange = data.weight_change;
            const userInfo = sharedData.user_info || {};

            console.log('üìä DEBUG: entries =', entries);
            console.log('üìä DEBUG: currentWeight =', currentWeight);
            console.log('üìä DEBUG: goalWeight =', goalWeight);

            // –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —Ç–µ–∫—É—â–∏–º –≤–µ—Å–æ–º (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–∑ webapp)
            let weightCardHtml = `
                <div class="weight-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="weight-current">${currentWeight ? currentWeight + ' –∫–≥' : (userInfo.weight ? userInfo.weight + ' –∫–≥' : '–ù–µ —É–∫–∞–∑–∞–Ω')}</div>
                            ${weightChange ? `
                                <div class="weight-change ${weightChange > 0 ? 'positive' : 'negative'}">
                                    ${weightChange > 0 ? '+' : ''}${weightChange} –∫–≥ –∑–∞ –ø–µ—Ä–∏–æ–¥
                                </div>
                            ` : ''}
                            ${goalWeight ? `
                                <div class="weight-goal">–¶–µ–ª—å: ${goalWeight} –∫–≥</div>
                            ` : (userInfo.goal ? `
                                <div class="weight-goal">–¶–µ–ª—å: ${userInfo.goal} –∫–≥</div>
                            ` : '')}
                            ${userInfo.height ? `
                                <div class="weight-height">–†–æ—Å—Ç: ${userInfo.height} —Å–º</div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // –ì—Ä–∞—Ñ–∏–∫ –≤–µ—Å–∞ (–±–µ–∑ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞)
            let chartHtml = `
                <div class="weight-chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            `;

            // –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞
            let historyHtml = `
                <div class="weight-history-table">
                    <div class="weight-history-header">
                        <i class="fas fa-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è –≤–µ—Å–∞
                    </div>
                    <div class="weight-history-content">
            `;

            if (entries && entries.length > 0) {
                entries.forEach((entry, index) => {
                    const date = new Date(entry.timestamp).toLocaleDateString('ru-RU');
                    const weight = entry.weight;
                    let change = '';
                    
                    if (index < entries.length - 1) {
                        const prevWeight = entries[index + 1].weight;
                        const diff = weight - prevWeight;
                        if (diff !== 0) {
                            change = `<span class="weight-change-small ${diff > 0 ? 'positive' : 'negative'}">${diff > 0 ? '+' : ''}${diff.toFixed(1)} –∫–≥</span>`;
                        }
                    }

                    historyHtml += `
                        <div class="weight-entry">
                            <div class="weight-entry-date">${date}</div>
                            <div class="weight-entry-weight">${weight} –∫–≥</div>
                            <div class="weight-entry-change">${change}</div>
                        </div>
                    `;
                });
            } else {
                historyHtml += `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-weight me-2"></i>
                        –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –≤–µ—Å–µ
                    </div>
                `;
            }

            historyHtml += `
                    </div>
                </div>
            `;

            // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å HTML
            weightContent.innerHTML = weightCardHtml + chartHtml + historyHtml;

            // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (entries && entries.length > 0) {
                console.log('üìä DEBUG: –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –¥–∞–Ω–Ω—ã–º–∏:', entries);
                setTimeout(() => {
                    createWeightChart(entries, goalWeight || userInfo.goal);
                }, 100);
            } else {
                console.log('üìä DEBUG: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
            }

            console.log(`‚úÖ DEBUG: –†–∞–∑–¥–µ–ª "–í–µ—Å" –æ—Ç–æ–±—Ä–∞–∂–µ–Ω —Å ${entries.length} –∑–∞–ø–∏—Å—è–º–∏`);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –≤–µ—Å–∞ (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–∑ webapp)
        function createWeightChart(entries, goalWeight) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            if (entries.length === 0) {
                const container = ctx.parentElement;
                container.innerHTML = `
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line"></i>
                        <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                        <small class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –≤–µ—Å–∞</small>
                    </div>
                `;
                return;
            }

            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp, —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –±—ã–ª–∏ —Å–ø—Ä–∞–≤–∞
            const sortedEntries = [...entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const labels = sortedEntries.map(entry => {
                const date = new Date(entry.timestamp);
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            });
            const weights = sortedEntries.map(entry => entry.weight);

            // –õ–∏–Ω–∏—è —Ü–µ–ª–∏
            const goalLine = goalWeight ? new Array(weights.length).fill(goalWeight) : [];

            // –ó–∞–≥—Ä—É–∂–∞–µ–º Chart.js –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            if (!window.Chart) {
                loadChartJS().then(() => {
                    createWeightChart(entries, goalWeight);
                });
                return;
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '–í–µ—Å',
                            data: weights,
                            borderColor: '#7a9b8e',
                            backgroundColor: 'rgba(122, 155, 142, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#7a9b8e',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            fill: true,
                            tension: 0.4
                        },
                        ...(goalWeight ? [{
                            label: '–¶–µ–ª—å',
                            data: goalLine,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            fill: false,
                            tension: 0,
                            borderDash: [6, 6]
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                },
                                callback: function(value) {
                                    return value + ' –∫–≥';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: goalWeight ? true : false,
                            position: 'top',
                            labels: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                },
                                usePointStyle: true,
                                pointStyle: 'line'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#7a9b8e',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' –∫–≥';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

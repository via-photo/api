<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Трекер питания</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-button-color: #4d6073;
            --tg-theme-button-text-color: #ffffff;
        }
        
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #222222);
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow-y: auto;
        }

        .content-container {
            flex-grow: 1;
            padding-bottom: 70px; /* Для нижней навигации */
            overflow-y: auto;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            color: #6c757d;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #7a9b8e;
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .section {
            display: none;
            padding: 20px;
        }

        .section.active {
            display: block;
        }

        .page-title {
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--tg-theme-text-color, #333);
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 16px;
            border: none;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }

        /* Стили для пустых секций */
        .empty-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #dee2e6;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #7a9b8e, #6b8b7d);
            border-color: #7a9b8e;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(122, 155, 142, 0.3);
        }
        
        .btn-outline-primary {
            color: #7a9b8e;
            border-color: #7a9b8e;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #7a9b8e, #6b8b7d);
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(122, 155, 142, 0.3);
        }
        
        .badge.bg-primary {
            background: linear-gradient(135deg, #7a9b8e, #6b8b7d) !important;
        }

        /* Корпоративные цвета для спиннеров */
        .text-primary {
            color: #7a9b8e !important;
        }
        
        .spinner-border.text-primary {
            border-color: #7a9b8e;
            border-right-color: transparent;
        }
        
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }

        .error-message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #debug-info {
            padding: 10px;
            background-color: #f8f9fa;
            margin-bottom: 10px;
            font-size: 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        /* Стили для итогов дня */
        .day-summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            margin-bottom: 20px;
        }

        .day-summary-card .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .nutrition-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .nutrition-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .nutrition-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .meal-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--tg-theme-button-color, #4d6073);
        }

        .meal-time {
            font-weight: 600;
            color: var(--tg-theme-button-color, #4d6073);
            font-size: 0.9rem;
        }

        .meal-description {
            margin: 5px 0;
            color: #333;
        }

        .meal-calories {
            font-size: 0.9rem;
            color: #666;
        }

        .warning-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--tg-theme-button-color, #4d6073);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
            background-color: #e9ecef;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--tg-theme-button-color, #4d6073), #667eea);
            transition: width 0.3s ease;
        }

        /* Стили для изображений блюд */
        .meal-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .meal-image:hover {
            transform: scale(1.05);
        }

        .meal-image-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            border: 2px solid #e9ecef;
            color: #6c757d;
            font-size: 24px;
        }

        /* Модальное окно для увеличенного изображения */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            cursor: pointer;
        }

        .image-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        .image-modal img {
            max-width: 95vw;
            max-height: 95vh;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            cursor: pointer;
        }

        /* Специальные стили для мобильных устройств */
        @media (max-width: 768px) {
            .image-modal img {
                max-width: 95vw;
                max-height: 85vh;
                min-width: 80vw;
                min-height: 60vh;
            }
            
            .image-modal-content {
                max-width: 95vw;
                max-height: 85vh;
            }
        }

        /* Для очень маленьких экранов (iPhone SE и подобные) */
        @media (max-width: 480px) {
            .image-modal img {
                max-width: 98vw;
                max-height: 80vh;
                min-width: 85vw;
                min-height: 65vh;
            }
        }

        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .image-modal-close:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Стили для раздела Вес */
        .weight-card {
            background: linear-gradient(135deg, #7a9b8e 0%, #5a7b6e 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(122, 155, 142, 0.3);
        }

        .weight-current {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .weight-change {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weight-change.positive {
            color: #ff6b6b;
        }

        .weight-change.negative {
            color: #51cf66;
        }

        .weight-goal {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .period-selector {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .period-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 70px;
        }

        .period-btn.active {
            background: #7a9b8e;
            color: white;
            box-shadow: 0 2px 8px rgba(122, 155, 142, 0.3);
        }

        .weight-chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: 300px;
            position: relative;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            flex-direction: column;
        }

        .chart-placeholder i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .weight-history-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .weight-history-header {
            background: #f8f9fa;
            padding: 15px 20px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .weight-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weight-entry:last-child {
            border-bottom: none;
        }

        .weight-entry-date {
            font-weight: 500;
            color: #333;
        }

        .weight-entry-value {
            font-weight: 600;
            color: #7a9b8e;
        }

        .weight-entry-change {
            font-size: 0.8rem;
            margin-left: 8px;
        }

        .weight-entry-change.positive {
            color: #ff6b6b;
        }

        .weight-entry-change.negative {
            color: #51cf66;
        }

        .weight-entry-delete {
            margin-left: 10px;
            background-color: #e9ecef; /* Светло-серый фон */
            border: none;
            cursor: pointer;
            width: 24px; /* Ширина кнопки */
            height: 24px; /* Высота кнопки */
            border-radius: 50%; /* Круглая форма */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0; /* Убрали паддинг, центрируем иконку через flex */
            transition: background-color 0.2s ease, opacity 0.2s ease;
            opacity: 0.8;
        }

        .weight-entry-delete:hover {
            background-color: #d8dfe3; /* Фон темнее при наведении */
            opacity: 1;
        }

        .weight-entry-delete .fas.fa-times {
            font-size: 12px; /* Маленький размер иконки */
            color: #495057; /* Темно-серый цвет иконки */
            line-height: 1; /* Для лучшего вертикального выравнивания иконки */
        }

         .add-weight-btn {
            background: #6c757d;
            border: none;
            border-radius: 12px;
            color: white;
            padding: 12px 20px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }
        .add-weight-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .weight-modal .modal-content {
            border-radius: 16px;
            border: none;
        }

        .weight-modal .modal-header {
            border-bottom: 1px solid #eee;
            padding: 20px;
        }

        .weight-modal .modal-body {
            padding: 20px;
        }

        .weight-input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .weight-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            transition: border-color 0.2s ease;
        }

        .weight-input:focus {
            border-color: #7a9b8e;
            box-shadow: 0 0 0 0.2rem rgba(122, 155, 142, 0.25);
            outline: none;
        }

        .weight-unit {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Отладочная информация -->
    <div id="debug-info" style="display: none;">Инициализация...</div>
    
    <!-- Модальное окно для изображений -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close">&times;</span>
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="Увеличенное изображение блюда">
        </div>
    </div>
    
    <div class="content-container">
        <!-- Секция Дневник -->
        <div id="diary-section" class="section active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="page-title" style="margin: 0;">📘 Дневник питания</h2>
                <button id="shareDiaryBtn" class="btn btn-outline-primary btn-sm" onclick="shareDiary()" style="display: flex; align-items: center; gap: 8px;">
                    📤 Поделиться дневником
                </button>
            </div>
            <div id="diary-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных дневника...</p>
                </div>
            </div>
        </div>

        <!-- Секция Статистика (с графиками) -->
        <div id="stats-section" class="section">
            <h2 class="page-title">📊 Статистика</h2>
            
            <!-- Навигация по неделям -->
            <div class="date-navigator" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%); border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(122, 155, 142, 0.3);">
                <button onclick="navigateWeek(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    ‹
                </button>
                <h3 id="weekRange" style="margin: 0; font-weight: 600; text-align: center;">Текущая неделя</h3>
                <button id="nextWeekBtn" onclick="navigateWeek(1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                    ›
                </button>
            </div>
            
            <div id="stats-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка статистики...</p>
                </div>
            </div>
        </div>

        <!-- Секция Избранное -->
        <div id="recipes-section" class="section">
            <h2 class="page-title">🌟 Избранное</h2>
            <div id="recipes-content">
                <!-- Фильтры и поиск -->
                <div class="card mb-3">
                    <div class="card-body" style="padding: 15px;">
                        <!-- Поиск -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text">🔍</span>
                                <input type="text" class="form-control" id="favorites-search" 
                                       placeholder="Поиск по названию или ингредиентам..." 
                                       oninput="filterFavorites()">
                            </div>
                        </div>
                        
                        <!-- Категории -->
                        <div class="mb-3">
                            <div class="d-flex flex-wrap gap-2" id="category-filters">
                                <button class="btn btn-sm btn-primary category-btn active" data-category="all" onclick="filterByCategory('all')">
                                    Все
                                </button>
                                <button class="btn btn-sm btn-outline-primary category-btn" data-category="breakfast" onclick="filterByCategory('breakfast')">
                                    🌅 Завтраки
                                </button>
                                <button class="btn btn-sm btn-outline-primary category-btn" data-category="lunch" onclick="filterByCategory('lunch')">
                                    🍽️ Обеды
                                </button>
                                <button class="btn btn-sm btn-outline-primary category-btn" data-category="dinner" onclick="filterByCategory('dinner')">
                                    🌙 Ужины
                                </button>
                                <button class="btn btn-sm btn-outline-primary category-btn" data-category="snack" onclick="filterByCategory('snack')">
                                    🥨 Перекусы
                                </button>
                            </div>
                        </div>
                        
                        <!-- Сортировка -->
                        <div class="d-flex align-items-center gap-2">
                            <span style="font-size: 0.9rem; color: #666;">Сортировка:</span>
                            <select class="form-select form-select-sm" id="sort-select" onchange="sortFavorites()" style="width: auto;">
                                <option value="date-desc">По дате (новые)</option>
                                <option value="date-asc">По дате (старые)</option>
                                <option value="calories-asc">По калориям (меньше)</option>
                                <option value="calories-desc">По калориям (больше)</option>
                                <option value="protein-desc">По белкам (больше)</option>
                                <option value="name-asc">По названию (А-Я)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Список избранных блюд -->
                <div id="favorites-list">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка избранного...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Секция Вес -->
        <div id="weight-section" class="section">
            <h2 class="page-title">⚖️ Вес</h2>
            <div id="weight-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных о весе...</p>
                </div>
            </div>
        </div>

        <!-- Секция Профиль (обновлена) -->
        <div id="profile-section" class="section">
            <h2 class="page-title">👤 Профиль</h2>
            <div id="profile-content">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка данных профиля...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Нижняя навигационная панель -->
    <nav class="bottom-nav">
        <div class="container">
            <div class="row text-center">
                <div class="col">
                    <a href="#diary" class="nav-item active" data-section="diary-section">
                        <div class="nav-icon">📘</div>
                        <span>Дневник</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#stats" class="nav-item" data-section="stats-section">
                        <div class="nav-icon">📊</div>
                        <span>Статистика</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#recipes" class="nav-item" data-section="recipes-section">
                        <div class="nav-icon">🌟</div>
                        <span>Избранное</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#weight" class="nav-item" data-section="weight-section">
                        <div class="nav-icon">⚖️</div>
                        <span>Вес</span>
                    </a>
                </div>
                <div class="col">
                    <a href="#profile" class="nav-item" data-section="profile-section">
                        <div class="nav-icon">👤</div>
                        <span>Профиль</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Модальное окно для добавления веса -->
    <div class="modal fade weight-modal" id="addWeightModal" tabindex="-1" aria-labelledby="addWeightModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWeightModalLabel">
                        <i class="fas fa-weight me-2"></i>Добавить новый вес
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addWeightForm">
                        <div class="weight-input-group">
                            <input type="number" class="weight-input" id="weightInput" 
                                   placeholder="Введите вес" step="0.1" min="30" max="250" required>
                            <span class="weight-unit">кг</span>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary flex-fill" data-bs-dismiss="modal">
                                Отмена
                            </button>
                            <button type="submit" class="btn btn-primary flex-fill" style="background: #7a9b8e; border-color: #7a9b8e;">
                                <i class="fas fa-save me-1"></i>Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js для графиков -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        /**
         * Система клиентского кэширования данных
         * Хранится в браузере пользователя, автоматически очищается по времени
         */
        class DataCache {
            constructor() {
                this.cache = new Map();
                this.defaultTTL = {
                    diary: 5 * 60 * 1000,      // 5 минут для дневника
                    stats: 10 * 60 * 1000,     // 10 минут для статистики  
                    profile: 30 * 60 * 1000,   // 30 минут для профиля
                    daySummary: 3 * 60 * 1000  // 3 минуты для итогов дня
                };
                
                // Автоматическая очистка устаревших данных каждые 2 минуты
                setInterval(() => this.cleanup(), 2 * 60 * 1000);
            }
            
            /**
             * Получить данные из кэша
             */
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                // Проверяем не истек ли TTL
                if (Date.now() > item.expiry) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.data;
            }
            
            /**
             * Сохранить данные в кэш
             */
            set(key, data, customTTL = null) {
                const keyType = key.split('_')[0]; // diary, stats, profile, etc.
                const ttl = customTTL || this.defaultTTL[keyType] || 5 * 60 * 1000;
                
                this.cache.set(key, {
                    data: data,
                    timestamp: Date.now(),
                    expiry: Date.now() + ttl
                });
            }
            
            /**
             * Удалить данные из кэша
             */
            delete(key) {
                this.cache.delete(key);
            }
            
            /**
             * Очистить весь кэш
             */
            clear() {
                this.cache.clear();
            }
            
            /**
             * Автоматическая очистка устаревших данных
             */
            cleanup() {
                const now = Date.now();
                for (const [key, item] of this.cache.entries()) {
                    if (now > item.expiry) {
                        this.cache.delete(key);
                    }
                }
            }
            
            /**
             * Получить статистику кэша (для отладки)
             */
            getStats() {
                const stats = {
                    totalItems: this.cache.size,
                    items: []
                };
                
                for (const [key, item] of this.cache.entries()) {
                    stats.items.push({
                        key: key,
                        size: JSON.stringify(item.data).length,
                        age: Math.round((Date.now() - item.timestamp) / 1000),
                        ttl: Math.round((item.expiry - Date.now()) / 1000)
                    });
                }
                
                return stats;
            }
        }
        
        // Глобальный экземпляр кэша
        const dataCache = new DataCache();
        
        /**
         * Ленивая загрузка Chart.js
         * Загружается только при переходе в статистику
         */
        let chartJSLoaded = false;
        let chartJSLoading = false;
        
        async function loadChartJS() {
            // Если уже загружена
            if (chartJSLoaded || window.Chart) {
                chartJSLoaded = true;
                return true;
            }
            
            // Если уже идет загрузка, ждем
            if (chartJSLoading) {
                return new Promise((resolve) => {
                    const checkLoaded = () => {
                        if (chartJSLoaded) {
                            resolve(true);
                        } else {
                            setTimeout(checkLoaded, 100);
                        }
                    };
                    checkLoaded();
                });
            }
            
            chartJSLoading = true;
            
            try {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.onload = () => {
                        chartJSLoaded = true;
                        chartJSLoading = false;
                        resolve();
                    };
                    script.onerror = () => {
                        chartJSLoading = false;
                        reject(new Error('Не удалось загрузить Chart.js'));
                    };
                    document.head.appendChild(script);
                });
                
                return true;
            } catch (error) {
                console.error('Ошибка при загрузке Chart.js:', error);
                return false;
            }
        }
        
        /**
         * Клиент API для взаимодействия с бэкендом Telegram бота
         */
        class TelegramBotApiClient {
            constructor(apiBaseUrl) {
                this.apiBaseUrl = apiBaseUrl || 'https://telegram-bot-api-h136.onrender.com/api';
                // Получаем API ключ из переменных окружения, если доступно
                this.apiKey = 'test_api_key';
                
                // Отладочное логирование удалено для оптимизации
            }

            /**
             * Получение итогов дня для пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @param {string} dateStr - Дата в формате YYYY-MM-DD (опционально)
             * @returns {Promise<Object>} - Данные итогов дня
             */
            async getDaySummary(userId, dateStr = null) {
                try {
                    // Создаем ключ для кэша
                    const cacheKey = `daySummary_${userId}_${dateStr || 'today'}`;
                    
                    // Проверяем кэш
                    const cachedData = dataCache.get(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    
                    const url = dateStr ? 
                        `${this.apiBaseUrl}/day-summary/${userId}?date_str=${dateStr}` : 
                        `${this.apiBaseUrl}/day-summary/${userId}`;
                    // Отладочное логирование удалено для оптимизации
                    const response = await this._fetchWithAuth(url);
                    
                    // Сохраняем в кэш
                    dataCache.set(cacheKey, response.data);
                    
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении итогов дня для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Получение данных дневника питания пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @param {string} dateStr - Дата в формате YYYY-MM-DD (опционально)
             * @returns {Promise<Object>} - Данные дневника питания
             */
            async getDiary(userId, dateStr = null) {
                try {
                    // Создаем ключ для кэша
                    const cacheKey = `diary_${userId}_${dateStr || 'today'}`;
                    
                    // Проверяем кэш
                    const cachedData = dataCache.get(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    
                    const url = dateStr ? 
                        `${this.apiBaseUrl}/diary-data/${userId}?date_str=${dateStr}` : 
                        `${this.apiBaseUrl}/diary-data/${userId}`;
                    // Отладочное логирование удалено для оптимизации
                    const response = await this._fetchWithAuth(url);
                    
                    // Сохраняем в кэш
                    dataCache.set(cacheKey, response.data);
                    
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении данных дневника для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Получение статистики пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @returns {Promise<Object>} - Данные статистики
             */
            async getStats(userId) {
                try {
                    // Создаем ключ для кэша
                    const cacheKey = `stats_${userId}`;
                    
                    // Проверяем кэш
                    const cachedData = dataCache.get(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    
                    // Отладочное логирование удалено для оптимизации
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/stats/${userId}`);
                    
                    // Сохраняем в кэш
                    dataCache.set(cacheKey, response.data);
                    
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении статистики для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
                    * Получение меню для пользователя
             * @param {string} userId - ID пользователя
             * @param {string} category - Категория блюд (опционально)
             * @returns {Promise<Object>} - Данные меню
             */
            async getMenu(userId, category = null) {
                try {
                    const params = category ? `?category=${category}` : '';
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/menu/${userId}${params}`);
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении меню для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Получение детальной информации о блюде
             * @param {number} dishId - ID блюда
             * @returns {Promise<Object>} - Данные блюда
             */
            async getDishDetails(dishId) {
                try {
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/menu/dish/${dishId}`);
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении информации о блюде ${dishId}:`, error);
                    throw error;
                }
            }

            /**
             * Поиск блюд в меню
             * @param {string} userId - ID пользователя
             * @param {string} query - Поисковый запрос
             * @returns {Promise<Object>} - Результаты поиска
             */
            async searchMenuDishes(userId, query) {
                try {
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/menu/search/${userId}?query=${encodeURIComponent(query)}`);
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при поиске блюд для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Добавление блюда из меню в дневник
             * @param {string} userId - ID пользователя
             * @param {number} dishId - ID блюда
             * @param {string} mealType - Тип приема пищи
             * @returns {Promise<Object>} - Результат операции
             */
            async addDishToDiary(userId, dishId, mealType = 'lunch') {
                try {
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/menu/add-to-diary`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            dish_id: dishId,
                            meal_type: mealType
                        })
                    });
                    return response;
                } catch (error) {
                    console.error(`Ошибка при добавлении блюда ${dishId} в дневник:`, error);
                    throw error;
                }
            }

            /**
                    * Получение избранных блюд для пользователя
             * @param {string} userId - ID пользователя
             * @returns {Promise<Object>} - Данные избранных блюд
             */
            async getRecipes(userId) {
                try {
                    // Отладочное логирование удалено для оптимизации
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/recipes/${userId}`);
                    return response.data;
                } catch (error) {
                    console.error(`Ошибка при получении избранных блюд для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Создание публичной ссылки для дневника
             * @param {string} userId - ID пользователя
             * @param {string} period - Период для экспорта (week, month, custom)
             * @param {string} startDate - Начальная дата (для custom)
             * @param {string} endDate - Конечная дата (для custom)
             * @returns {Promise<Object>} - Данные с публичной ссылкой
             */
            async createDiaryShare(userId, period = 'week', startDate = null, endDate = null) {
                try {
                    const params = new URLSearchParams({
                        period,
                        ...(startDate && { start_date: startDate }),
                        ...(endDate && { end_date: endDate })
                    });
                    
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/diary/${userId}/share?${params}`, {
                        method: 'POST'
                    });
                    return response;
                } catch (error) {
                    console.error(`Ошибка при создании публичной ссылки для пользователя ${userId}:`, error);
                    throw error;
                }
            }

            /**
             * Получение данных профиля пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @returns {Promise<Object>} - Данные профиля
             */
            async getUserProfile(userId) {
                try {
                    // Создаем ключ для кэша
                    const cacheKey = `profile_${userId}`;
                    
                    // Проверяем кэш
                    const cachedData = dataCache.get(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    
                    // Отладочное логирование удалено для оптимизации
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/profile/${userId}`);
                    
                    // Сохраняем в кэш
                    dataCache.set(cacheKey, response.data);
                    
                    return response.data;
                } catch (error) {
                    console.error('Ошибка при получении данных профиля:', error);
                    throw error;
                }
            }

            /**
             * Удаление записи веса
             * @param {string} userId - ID пользователя в Telegram
             * @param {string} timestamp - Временная метка записи для удаления
             * @returns {Promise<Object>} - Результат операции
             */
            async deleteWeightEntry(userId, timestamp) {
                try {
                    
                    // Выполняем DELETE запрос к API
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/weight/${userId}?timestamp=${encodeURIComponent(timestamp)}`, {
                        method: 'DELETE'
                    });
                    
                    // Инвалидируем кэш веса и профиля после удаления
                    const cacheKeys = [
                        `weight_${userId}_week`,
                        `weight_${userId}_month`,
                        `weight_${userId}_6months`,
                        `weight_${userId}_year`,
                        `profile_${userId}`
                    ];
                    
                    cacheKeys.forEach(key => dataCache.delete(key));
                    
                    return {
                        success: true,
                        data: response.data
                    };
                } catch (error) {
                    console.error('Ошибка при удалении записи веса:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            /**
             * Обновление данных профиля пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @param {Object} profileData - Данные для обновления
             * @returns {Promise<Object>} - Результат операции
             */
            async updateUserProfile(userId, profileData) {
                try {
                    console.log(`Обновление профиля для пользователя: ${userId}`);
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/profile/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(profileData)
                    });
                    
                    // Инвалидируем кэш профиля после обновления
                    dataCache.delete(`profile_${userId}`);
                    // Также инвалидируем статистику, так как она может зависеть от профиля
                    dataCache.delete(`stats_${userId}`);
                    
                    return response;
                } catch (error) {
                    console.error('Ошибка при обновлении профиля:', error);
                    throw error;
                }
            }

            /**
             * Пересчет целевых значений пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @returns {Promise<Object>} - Результат операции
             */
            async recalculateTargets(userId) {
                try {
                    console.log(`Пересчет целевых значений для пользователя: ${userId}`);
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/profile/${userId}/recalculate`, {
                        method: 'POST'
                    });
                    return response;
                } catch (error) {
                    console.error('Ошибка при пересчете целевых значений:', error);
                    throw error;
                }
            }

            /**
             * Добавление приема пищи
             * @param {Object} mealData - Данные о приеме пищи
             * @returns {Promise<Object>} - Результат операции
             */
            async addMeal(mealData) {
                try {
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/meal`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(mealData)
                    });
                    return response;
                } catch (error) {
                    console.error('Ошибка при добавлении приема пищи:', error);
                    throw error;
                }
            }

            /**
             * Вспомогательный метод для выполнения запросов с аутентификацией
             * @param {string} url - URL для запроса
             * @param {Object} options - Опции запроса
             * @returns {Promise<Object>} - Результат запроса
             * @private
             */
            async _fetchWithAuth(url, options = {}) {
                const headers = {
                    'X-API-Key': this.apiKey,
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0',
                    ...(options.headers || {})
                };

                // Добавляем timestamp для обхода кэша браузера
                const separator = url.includes('?') ? '&' : '?';
                const urlWithTimestamp = `${url}${separator}_t=${Date.now()}`;

                // Расширенное логирование для отладки
                console.log(`Выполнение запроса к: ${urlWithTimestamp}`);
                console.log('Заголовки запроса:', headers);
                console.log('API ключ:', this.apiKey);
                console.log('Опции запроса:', options);
                
                // Добавляем информацию в отладочную панель
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.innerHTML += `<br>Запрос к: ${urlWithTimestamp}`;
                    debugInfo.innerHTML += `<br>API ключ: ${this.apiKey}`;
                }

                try {
                    const response = await fetch(urlWithTimestamp, {
                        ...options,
                        headers
                    });

                    // Логируем полный ответ
                    console.log(`Статус ответа: ${response.status} ${response.statusText}`);
                    console.log('Заголовки ответа:', response.headers);
                    
                    if (debugInfo) {
                        debugInfo.innerHTML += `<br>Статус ответа: ${response.status} ${response.statusText}`;
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Ошибка API: ${response.status} ${response.statusText}`);
                        console.error('Текст ошибки:', errorText);
                        
                        if (debugInfo) {
                            debugInfo.innerHTML += `<br>Ошибка API: ${response.status} ${response.statusText}`;
                            debugInfo.innerHTML += `<br>Текст ошибки: ${errorText}`;
                        }
                        
                        throw new Error(`API запрос не удался: ${response.status} ${response.statusText} - ${errorText}`);
                    }

                    const data = await response.json();
                    console.log('Данные ответа:', data);
                    return data;
                } catch (error) {
                    console.error('Ошибка при выполнении запроса:', error);
                    
                    if (debugInfo) {
                        debugInfo.innerHTML += `<br>Ошибка при выполнении запроса: ${error.message}`;
                    }
                    
                    throw error;
                }
            }

            /**
             * Получение истории веса пользователя
             * @param {string} userId - ID пользователя в Telegram
             * @param {string} period - Период (week, month, 6months, year)
             * @returns {Promise<Object>} - Данные о весе
             */
            async getWeightHistory(userId, period = 'month') {
                try {
                    const cacheKey = `weight_${userId}_${period}`;
                    
                    // Проверяем кэш
                    const cachedData = dataCache.get(cacheKey);
                    if (cachedData) {
                        return cachedData;
                    }
                    
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/weight/${userId}?period=${period}`);
                    
                    // Сохраняем в кэш на 5 минут
                    dataCache.set(cacheKey, response.data, 5 * 60 * 1000);
                    
                    return response.data;
                } catch (error) {
                    console.error('Ошибка при получении истории веса:', error);
                    throw error;
                }
            }

            /**
             * Добавление новой записи веса
             * @param {string} userId - ID пользователя в Telegram
             * @param {Object} weightData - Данные о весе {weight, note}
             * @returns {Promise<Object>} - Результат операции
             */
            async addWeightEntry(userId, weightData) {
                try {
                    console.log(`Добавление веса для пользователя: ${userId}`, weightData);
                    
                    // Используем ту же логику что и в боте для пересчета КБЖУ
                    const response = await this._fetchWithAuth(`${this.apiBaseUrl}/weight/${userId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            weight: weightData.weight,
                            note: weightData.note || '',
                            recalculate_targets: true  // Флаг для пересчета как в боте
                        })
                    });
                    
                    // Инвалидируем кэш веса и профиля после добавления
                    const cacheKeys = [
                        `weight_${userId}_week`,
                        `weight_${userId}_month`,
                        `weight_${userId}_6months`,
                        `weight_${userId}_year`,
                        `profile_${userId}`,
                        `stats_${userId}`
                    ];
                    cacheKeys.forEach(key => dataCache.delete(key));
                    
                    return response;
                } catch (error) {
                    console.error('Ошибка при добавлении веса:', error);
                    throw error;
                }
            }
        }

        // Основной код приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация отладочной информации
            updateDebugInfo();
            
            // Инициализация API клиента
            const apiClient = new TelegramBotApiClient();
            
            // Инициализация Telegram WebApp
            initTelegramWebApp();
            
            // Загрузка данных для всех разделов
            loadAllData();
            
            // Обработка навигации
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.section');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Удаляем активный класс у всех элементов навигации
                    navItems.forEach(navItem => navItem.classList.remove('active'));
                    
                    // Добавляем активный класс текущему элементу
                    this.classList.add('active');
                    
                    // Скрываем все секции
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // Показываем нужную секцию
                    const sectionId = this.getAttribute('data-section');
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Загружаем данные для соответствующей секции
                    const userId = getUserId();
                    if (sectionId === 'diary-section') {
                        loadDiaryData(userId);
                    } else if (sectionId === 'stats-section') {
                        loadStatsData(userId);
                    } else if (sectionId === 'recipes-section') {
                        loadRecipesData(userId);
                    } else if (sectionId === 'weight-section') {
                        loadWeightData(userId, currentWeightPeriod);
                    } else if (sectionId === 'profile-section') {
                        loadProfileData(userId);
                    }
                    
                    // Прокручиваем страницу вверх
                    window.scrollTo(0, 0);
                });
            });

            // Обработчик для кнопки "Добавить приём пищи"
            document.addEventListener('click', function(e) {
                if (e.target.closest('#addMealBtn')) {
                    sendDataToBot({
                        action: 'add_meal',
                        timestamp: new Date().toISOString()
                    });
                }
            });

            // Обработчик для кнопок "Подробнее" в избранных блюдах
            document.addEventListener('click', function(e) {
                if (e.target.closest('.recipe-details-btn')) {
                    const recipeCard = e.target.closest('.card');
                    const recipeTitle = recipeCard.querySelector('.card-title').textContent;
                    
                    sendDataToBot({
                        action: 'get_recipe_details',
                        recipe: recipeTitle
                    });
                }
            });
        });

        /**
         * Функция для загрузки и отображения статистики с итогами дня
         */
        async function loadStatsData(userId) {
            // Отладочное логирование удалено для оптимизации
            const statsContent = document.getElementById('stats-content');
            
            try {
                statsContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка библиотеки графиков...</p>
                    </div>
                `;
                
                // Загружаем Chart.js перед отображением графиков
                const chartLoaded = await loadChartJS();
                if (!chartLoaded) {
                    throw new Error('Не удалось загрузить библиотеку графиков');
                }
                
                // Обновляем сообщение о загрузке
                statsContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка статистики...</p>
                    </div>
                `;
                
                // Отладочное логирование удалено для оптимизации
                const apiClient = new TelegramBotApiClient();
                const statsData = await apiClient.getStats(userId);
                
                await renderStatsWithCharts(statsData);
            } catch (error) {
                console.error('Ошибка при загрузке статистики:', error);
                statsContent.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> Не удалось загрузить статистику. Пожалуйста попробуйте позже.</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadStatsData(getUserId())">
                            <i class="fas fa-sync-alt"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Функция для отображения статистики с итогами дня
         */
        function renderStatsData(statsData) {
            // Отладочное логирование удалено для оптимизации
            
            const statsContent = document.getElementById('stats-content');
            
            let todaySummaryHtml = '';
            
            // Отображаем итоги дня, если они есть
            if (statsData.today_summary) {
                const summary = statsData.today_summary;
                
                todaySummaryHtml = `
                    <div class="card day-summary-card">
                        <div class="card-header">
                            <h5 class="mb-0">🍎 Итоги за сегодня</h5>
                        </div>
                        <div class="card-body">
                            ${summary.message ? `
                                <div class="text-center py-3">
                                    <p class="mb-0" style="color: #6c757d;">${summary.message}</p>
                                </div>
                            ` : `
                                <div class="nutrition-grid">
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${summary.total_calories}</div>
                                        <div class="nutrition-label">Калории</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${summary.total_protein}</div>
                                        <div class="nutrition-label">Белки (г)</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${summary.total_fat}</div>
                                        <div class="nutrition-label">Жиры (г)</div>
                                    </div>
                                    <div class="nutrition-item">
                                        <div class="nutrition-value">${summary.total_carb}</div>
                                        <div class="nutrition-label">Углеводы (г)</div>
                                    </div>
                                </div>
                                
                                ${summary.meals && summary.meals.length > 0 ? `
                                    <h6 class="mb-3">Приемы пищи:</h6>
                                    ${summary.meals.map(meal => `
                                        <div class="meal-item">
                                            <div class="meal-time">${meal.time}</div>
                                            <div class="meal-description">${meal.description}</div>
                                            <div class="meal-calories">${meal.calories} ккал</div>
                                        </div>
                                    `).join('')}
                                ` : ''}
                                
                                ${summary.remaining_calories > 0 || summary.remaining_protein > 0 || summary.remaining_fat > 0 || summary.remaining_carb > 0 ? `
                                    <h6 class="mb-3 mt-4">Осталось на сегодня:</h6>
                                    <div class="nutrition-grid">
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${summary.remaining_calories}</div>
                                            <div class="nutrition-label">Калории</div>
                                        </div>
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${summary.remaining_protein}</div>
                                            <div class="nutrition-label">Белки (г)</div>
                                        </div>
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${summary.remaining_fat}</div>
                                            <div class="nutrition-label">Жиры (г)</div>
                                        </div>
                                        <div class="nutrition-item">
                                            <div class="nutrition-value">${summary.remaining_carb}</div>
                                            <div class="nutrition-label">Углеводы (г)</div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${summary.warnings && summary.warnings.length > 0 ? `
                                    <div class="mt-4">
                                        <h6 class="mb-3">Рекомендации:</h6>
                                        ${summary.warnings.map(warning => `
                                            <div class="warning-item">${warning}</div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    </div>
                `;
            }
            
            // Общая статистика
            const general = statsData.general;
            const nutrition = statsData.nutrition_distribution;
            const targets = statsData.user_targets;
            
            statsContent.innerHTML = `
                ${todaySummaryHtml}
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">📈 Общая статистика</h5>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${general.avg_calories}</div>
                                <div class="stat-label">Средние калории в день</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${general.days_tracked}</div>
                                <div class="stat-label">Дней отслежено</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${general.adherence_percent}%</div>
                                <div class="stat-label">Соблюдение нормы</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${general.weight_change > 0 ? '+' : ''}${general.weight_change}</div>
                                <div class="stat-label">Изменение веса (кг)</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Прогресс по калориям</h6>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${Math.min(100, (general.avg_calories / targets.calories) * 100)}%"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">${general.avg_calories} ккал</small>
                                <small class="text-muted">Цель: ${targets.calories} ккал</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">🥗 Распределение БЖУ</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Белки</span>
                                <span>${nutrition.protein}%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${nutrition.protein}%; background: #7a9b8e;"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Жиры</span>
                                <span>${nutrition.fat}%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${nutrition.fat}%; background: #ffc107;"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Углеводы</span>
                                <span>${nutrition.carb}%</span>
                            </div>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${nutrition.carb}%; background: #17a2b8;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${statsData.top_products && statsData.top_products.length > 0 ? `
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">🏆 Топ продуктов</h5>
                        </div>
                        <div class="card-body">
                            ${statsData.top_products.map((product, index) => `
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span>${index + 1}. ${product.name}</span>
                                    <span class="badge bg-primary">${product.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">🎯 Целевые значения</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-2">
                                <small class="text-muted">Калории:</small>
                                <div class="fw-bold">${targets.calories} ккал</div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted">Белки:</small>
                                <div class="fw-bold">${targets.protein} г</div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted">Жиры:</small>
                                <div class="fw-bold">${targets.fat} г</div>
                            </div>
                            <div class="col-6 mb-2">
                                <small class="text-muted">Углеводы:</small>
                                <div class="fw-bold">${targets.carb} г</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Функция для загрузки данных профиля
         */
        async function loadProfileData(userId) {
            const profileContent = document.getElementById('profile-content');
            
            try {
                profileContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка данных профиля...</p>
                    </div>
                `;
                
                const apiClient = new TelegramBotApiClient();
                const profileData = await apiClient.getUserProfile(userId);
                
                renderProfileData(profileData);
            } catch (error) {
                console.error('Ошибка при загрузке профиля:', error);
                profileContent.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> Не удалось загрузить данные. Пожалуйста попробуйте позже.</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadProfileData('${userId}')">
                            <i class="fas fa-sync-alt"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Функция для отображения данных профиля
         */
        function renderProfileData(profileData) {
            const profileContent = document.getElementById('profile-content');
            
            // Форматирование целевых значений
            const targetKcal = profileData.target_kcal || 0;
            const targetProtein = profileData.target_protein || 0;
            const targetFat = profileData.target_fat || 0;
            const targetCarb = profileData.target_carb || 0;
            const targetFiber = profileData.target_fiber || 0;
            
            // Определение уровня активности в текстовом виде
            let activityText = "Не указано";
            switch(profileData.activity) {
                case "низкий":
                    activityText = "Минимальная";
                    break;
                case "средний":
                    activityText = "Средняя";
                    break;
                case "высокий":
                    activityText = "Высокая";
                    break;
            }
            
            // Определение пола в текстовом виде
            const genderText = profileData.gender === "муж" ? "Мужской" : 
                               profileData.gender === "жен" ? "Женский" : "Не указано";
            
            profileContent.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Личные данные</span>
                        <button class="btn btn-sm btn-outline-primary edit-profile-btn" data-section="personal">
                            <i class="fas fa-pencil-alt"></i> Изменить
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Пол:</div>
                            <div class="col-6">${genderText}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Возраст:</div>
                            <div class="col-6">${profileData.age || "Не указано"} лет</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Рост:</div>
                            <div class="col-6">${profileData.height || "Не указано"} см</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Текущий вес:</div>
                            <div class="col-6">${profileData.weight || "Не указано"} кг</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Желаемый вес:</div>
                            <div class="col-6">${profileData.goal || "Не указано"} кг</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Активность:</div>
                            <div class="col-6">${activityText}</div>
                        </div>
                        ${profileData.gender === "жен" ? `
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Беременность/ГВ:</div>
                            <div class="col-6">${profileData.pregnant ? "Да" : "Нет"}</div>
                        </div>` : ''}
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <span>Целевые значения</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Калории:</div>
                            <div class="col-6">${targetKcal} ккал</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Белки:</div>
                            <div class="col-6">${targetProtein} г</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Жиры:</div>
                            <div class="col-6">${targetFat} г</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Углеводы:</div>
                            <div class="col-6">${targetCarb} г</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Клетчатка:</div>
                            <div class="col-6">${targetFiber} г</div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Целевые значения автоматически пересчитываются при изменении личных данных
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Настройки</span>
                        <button class="btn btn-sm btn-outline-primary edit-profile-btn" data-section="settings">
                            <i class="fas fa-cog"></i> Изменить
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Часовой пояс:</div>
                            <div class="col-6">UTC ${profileData.utc_offset >= 0 ? '+' : ''}${profileData.utc_offset}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Утренние напоминания:</div>
                            <div class="col-6">${profileData.morning_reminders_enabled !== undefined ? (profileData.morning_reminders_enabled ? "Включены" : "Выключены") : "Включены"}</div>
                        </div>
                    </div>
                </div>
                
                <button id="logoutBtn" class="btn btn-outline-danger w-100 mb-4">
                    <i class="fas fa-sign-out-alt"></i> Выйти из приложения
                </button>
            `;
            
            // Добавляем обработчики событий для кнопок редактирования
            document.querySelectorAll('.edit-profile-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showEditProfileForm(section, profileData);
                });
            });
            
            // Обработчик для кнопки пересчета целевых значений - УДАЛЕН
            // Кнопка "Пересчитать" убрана, пересчет происходит автоматически при изменении личных данных
            
            // Обработчик для кнопки выхода
            document.getElementById('logoutBtn').addEventListener('click', function() {
                // Очищаем локальное хранилище
                localStorage.removeItem('telegramUser');
                // Закрываем WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                } else {
                    alert('Функция доступна только в Telegram');
                }
            });
        }

        /**
         * Функция для отображения формы редактирования профиля
         */
        function showEditProfileForm(section, profileData) {
            const profileContent = document.getElementById('profile-content');
            
            if (section === 'personal') {
                profileContent.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header">
                            <span>Редактирование личных данных</span>
                        </div>
                        <div class="card-body">
                            <form id="personalDataForm">
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Пол</label>
                                    <select class="form-select" id="gender" required>
                                        <option value="муж" ${profileData.gender === "муж" ? "selected" : ""}>Мужской</option>
                                        <option value="жен" ${profileData.gender === "жен" ? "selected" : ""}>Женский</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="age" class="form-label">Возраст (лет)</label>
                                    <input type="number" class="form-control" id="age" value="${profileData.age || ""}" min="12" max="100" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="height" class="form-label">Рост (см)</label>
                                    <input type="number" class="form-control" id="height" value="${profileData.height || ""}" min="100" max="250" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="weight" class="form-label">Текущий вес (кг)</label>
                                    <input type="number" class="form-control" id="weight" value="${profileData.weight || ""}" min="30" max="250" step="0.1" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="goal" class="form-label">Желаемый вес (кг)</label>
                                    <input type="number" class="form-control" id="goal" value="${profileData.goal || ""}" min="30" max="250" step="0.1" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="activity" class="form-label">Уровень активности</label>
                                    <select class="form-select" id="activity" required>
                                        <option value="низкий" ${profileData.activity === "низкий" ? "selected" : ""}>Минимальная</option>
                                        <option value="средний" ${profileData.activity === "средний" ? "selected" : ""}>Средняя</option>
                                        <option value="высокий" ${profileData.activity === "высокий" ? "selected" : ""}>Высокая</option>
                                    </select>
                                    <div class="form-text">
                                        <small>
                                            <strong>Минимальная</strong> — сидячая работа, почти нет движения в течение дня, нет тренировок.<br>
                                            <strong>Средняя</strong> — немного двигаешься в течение дня, бывают лёгкие тренировки 1–2 раза в неделю.<br>
                                            <strong>Высокая</strong> — активный образ жизни или регулярные тренировки 3–5 раз в неделю.
                                        </small>
                                    </div>
                                </div>
                                
                                ${profileData.gender === "жен" ? `
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="pregnant" ${profileData.pregnant ? "checked" : ""}>
                                    <label class="form-check-label" for="pregnant">Беременность или грудное вскармливание</label>
                                </div>` : ''}
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary cancel-edit-btn">Отмена</button>
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            } else if (section === 'settings') {
                profileContent.innerHTML = `
                    <div class="card mb-4">
                        <div class="card-header">
                            <span>Редактирование настроек</span>
                        </div>
                        <div class="card-body">
                            <form id="settingsForm">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Часовой пояс (UTC)</label>
                                    <select class="form-select" id="timezone" required>
                                        ${generateTimezoneOptions(profileData.utc_offset)}
                                    </select>
                                </div>
                                
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="morningReminders" ${profileData.morning_reminders_enabled !== undefined ? (profileData.morning_reminders_enabled ? "checked" : "") : "checked"}>
                                    <label class="form-check-label" for="morningReminders">Утренние напоминания</label>
                                    <div class="form-text">Бот будет напоминать о необходимости записать завтрак</div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary cancel-edit-btn">Отмена</button>
                                    <button type="submit" class="btn btn-primary">Сохранить</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            }
            
            // Обработчик для кнопки отмены
            document.querySelector('.cancel-edit-btn').addEventListener('click', function() {
                const userId = getUserId();
                loadProfileData(userId);
            });
            
            // Обработчик для формы личных данных
            if (section === 'personal') {
                document.getElementById('personalDataForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = getUserId();
                    const updatedData = {
                        gender: document.getElementById('gender').value,
                        age: parseInt(document.getElementById('age').value),
                        height: parseInt(document.getElementById('height').value),
                        weight: parseFloat(document.getElementById('weight').value),
                        goal: parseFloat(document.getElementById('goal').value),
                        activity: document.getElementById('activity').value
                    };
                    
                    // Добавляем поле беременности только для женщин
                    if (updatedData.gender === "жен") {
                        updatedData.pregnant = document.getElementById('pregnant').checked;
                    }
                    
                    updateProfile(userId, updatedData);
                });
            }
            
            // Обработчик для формы настроек
            if (section === 'settings') {
                document.getElementById('settingsForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = getUserId();
                    const updatedData = {
                        utc_offset: parseInt(document.getElementById('timezone').value),
                        morning_reminders_enabled: document.getElementById('morningReminders').checked
                    };
                    
                    updateProfile(userId, updatedData);
                });
            }
        }

        /**
         * Функция для обновления профиля с автоматическим пересчетом целевых значений
         */
        async function updateProfile(userId, updatedData) {
            const profileContent = document.getElementById('profile-content');
            
            try {
                profileContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Сохранение данных и пересчет целевых значений...</p>
                    </div>
                `;
                
                const apiClient = new TelegramBotApiClient();
                const updateResponse = await apiClient.updateUserProfile(userId, updatedData);
                
                // Очищаем весь кэш пользователя после обновления профиля
                const cacheKeys = [
                    `profile_${userId}`,
                    `stats_${userId}`,
                    `diary_${userId}`,
                    `day_summary_${userId}`
                ];
                
                cacheKeys.forEach(key => {
                    dataCache.delete(key);
                });
                
                // Дополнительно очищаем кэш с различными датами
                for (let i = -30; i <= 30; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    dataCache.delete(`day_summary_${userId}_${dateStr}`);
                    dataCache.delete(`diary_data_${userId}_${dateStr}`);
                }
                
                console.log('Кэш очищен после обновления профиля');
                
                // Загружаем обновленные данные профиля
                const updatedProfileData = await apiClient.getUserProfile(userId);
                renderProfileData(updatedProfileData);
                
                // Показываем уведомление об успешном обновлении
                let message = 'Данные профиля успешно обновлены';
                if (updateResponse.recalculated) {
                    message += ' и целевые значения пересчитаны';
                }
                showToast(message);
                
                // Обновляем другие разделы если они загружены
                setTimeout(() => {
                    // Обновляем статистику если она видна
                    const statsSection = document.getElementById('stats-section');
                    if (statsSection && !statsSection.classList.contains('active') === false) {
                        loadStatsData(userId);
                    }
                    
                    // Обновляем дневник если он виден
                    const diarySection = document.getElementById('diary-section');
                    if (diarySection && diarySection.classList.contains('active')) {
                        loadDiaryData(userId);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Ошибка при обновлении профиля:', error);
                profileContent.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> Не удалось обновить данные. Пожалуйста попробуйте позже.</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadProfileData('${userId}')">
                            <i class="fas fa-sync-alt"></i> Вернуться к профилю
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Функция для пересчета целевых значений
         */
        async function recalculateTargets(profileData) {
            const userId = getUserId();
            const profileContent = document.getElementById('profile-content');
            
            try {
                profileContent.innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Пересчет целевых значений...</p>
                    </div>
                `;
                
                const apiClient = new TelegramBotApiClient();
                await apiClient.recalculateTargets(userId);
                
                // Если пересчет прошел успешно, загружаем обновленные данные
                const updatedProfileData = await apiClient.getUserProfile(userId);
                renderProfileData(updatedProfileData);
                
                // Показываем уведомление об успешном пересчете
                showToast('Целевые значения успешно пересчитаны');
            } catch (error) {
                console.error('Ошибка при пересчете целевых значений:', error);
                profileContent.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> Не удалось пересчитать целевые значения. Пожалуйста попробуйте позже.</p>
                        <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadProfileData('${userId}')">
                            <i class="fas fa-sync-alt"></i> Вернуться к профилю
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Функция для генерации опций часовых поясов
         */
        function generateTimezoneOptions(currentOffset) {
            let options = '';
            for (let i = -12; i <= 14; i++) {
                options += `<option value="${i}" ${i === currentOffset ? 'selected' : ''}>UTC ${i >= 0 ? '+' : ''}${i}</option>`;
            }
            return options;
        }

        /**
         * Функция для отображения уведомления
         */
        function showToast(message) {
            // Создаем элемент уведомления
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.bottom = '20px';
            toastContainer.style.left = '50%';
            toastContainer.style.transform = 'translateX(-50%)';
            toastContainer.style.zIndex = '9999';
            
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.style.minWidth = '250px';
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">Уведомление</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            // Удаляем уведомление через 3 секунды
            setTimeout(() => {
                document.body.removeChild(toastContainer);
            }, 3000);
        }

        /**
         * Функция для обновления отладочной информации
         */
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = 'Инициализация...';
            
            // Проверяем URL параметры
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('userId');
            if (userIdFromUrl) {
                debugInfo.innerHTML += `<br>userId из URL: ${userIdFromUrl}`;
            } else {
                debugInfo.innerHTML += '<br>userId в URL не найден';
            }
            
            // Проверяем Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                debugInfo.innerHTML += '<br>Telegram WebApp доступен';
                if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    debugInfo.innerHTML += `<br>Telegram user: ${user.id} (${user.first_name})`;
                } else {
                    debugInfo.innerHTML += '<br>Данные пользователя в Telegram WebApp не найдены';
                }
            } else {
                debugInfo.innerHTML += '<br>Telegram WebApp не доступен';
            }
            
            // Проверяем localStorage
            const savedUser = localStorage.getItem('telegramUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    debugInfo.innerHTML += `<br>localStorage user: ${userData.id}`;
                } catch (e) {
                    debugInfo.innerHTML += '<br>Ошибка при чтении localStorage';
                }
            } else {
                debugInfo.innerHTML += '<br>Данные пользователя в localStorage не найдены';
            }
            
            // Итоговый userId
            const userId = getUserId();
            debugInfo.innerHTML += `<br>Итоговый userId: ${userId || 'не определен'}`;
        }

        /**
         * Функция для загрузки всех данных с улучшенной обработкой ошибок
         */
        async function loadAllData() {
            const userId = getUserId();
            
            if (!userId) {
                const errorMessage = 'Не удалось получить ID пользователя. Пожалуйста, убедитесь, что вы открыли приложение через Telegram бота.';
                showError('diary-content', errorMessage);
                showError('stats-content', errorMessage);
                showError('recipes-content', errorMessage);
                showError('profile-content', errorMessage);
                return;
            }
            
            // Загружаем данные для всех разделов
            await Promise.all([
                loadDiaryData(userId),
                loadStatsData(userId),
                loadRecipesData(userId),
                loadProfileData(userId)
            ]);
        }

        /**
         * Исправленная функция для получения ID пользователя из Telegram WebApp
         */
        function getUserId() {
            // Сначала пробуем получить из Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                console.log('Получен userId из Telegram WebApp:', window.Telegram.WebApp.initDataUnsafe.user.id);
                return window.Telegram.WebApp.initDataUnsafe.user.id.toString();
            }
            
            // Затем пробуем получить из URL параметров
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('userId');
            if (userIdFromUrl) {
                console.log('Получен userId из URL параметров:', userIdFromUrl);
                return userIdFromUrl;
            }
            
            // Затем пробуем из localStorage
            const savedUser = localStorage.getItem('telegramUser');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    if (userData && userData.id) {
                        console.log('Получен userId из localStorage:', userData.id);
                        return userData.id.toString();
                    }
                } catch (e) {
                    console.error('Ошибка при парсинге данных пользователя из localStorage:', e);
                }
            }
            
            console.error('Не удалось получить userId. WebApp должен быть запущен из Telegram.');
            return null;
        }

        /**
         * Исправленная функция для инициализации Telegram WebApp
         */
        function initTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                // Расширяем WebApp на весь экран
                tg.expand();
                
                // Сохраняем данные пользователя в localStorage для последующего использования
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    localStorage.setItem('telegramUser', JSON.stringify(tg.initDataUnsafe.user));
                    console.log('Данные пользователя сохранены в localStorage:', tg.initDataUnsafe.user);
                }
                
                // Настраиваем тему
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#222222');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#4d6073');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                
                console.log('Telegram WebApp инициализирован');
            } else {
                console.warn('Telegram WebApp не доступен. Приложение может работать некорректно.');
            }
        }

        /**
         * Функция для отправки данных боту через Telegram WebApp
         */
        function sendDataToBot(data) {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.sendData(JSON.stringify(data));
                console.log('Данные отправлены боту:', data);
            } else {
                console.warn('Telegram WebApp не доступен. Данные не могут быть отправлены боту.');
                alert('Функция доступна только в Telegram');
            }
        }

        /**
         * Функция для отображения ошибки в указанном контейнере
         */
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="error-message">
                        <p><i class="fas fa-exclamation-circle"></i> ${message}</p>
                    </div>
                `;
            }
        }

        // Заглушки для других функций загрузки данных
        // Глобальные переменные для навигации по дням в дневнике
        let currentDayOffset = 0;

        /**
         * Функция для создания публичной ссылки на дневник
         */
        async function shareDiary() {
            try {
                const userId = getUserId();
                const shareDiaryBtn = document.getElementById('shareDiaryBtn');
                
                // Показываем индикатор загрузки
                const originalText = shareDiaryBtn.innerHTML;
                shareDiaryBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Создание ссылки...';
                shareDiaryBtn.disabled = true;
                
                // Создаем API клиент и получаем публичную ссылку
                const apiClient = new TelegramBotApiClient();
                const result = await apiClient.createDiaryShare(userId, 'week');
                
                if (result.success && result.share_url) {
                    // Пробуем скопировать ссылку в буфер обмена разными способами
                    let copySuccess = false;
                    
                    try {
                        // Способ 1: Современный Clipboard API
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(result.share_url);
                            copySuccess = true;
                        }
                    } catch (e) {
                        console.log('Clipboard API не сработал:', e);
                    }
                    
                    if (!copySuccess) {
                        try {
                            // Способ 2: Создаем временный input элемент
                            const textArea = document.createElement('textarea');
                            textArea.value = result.share_url;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-999999px';
                            textArea.style.top = '-999999px';
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            
                            // Пытаемся скопировать через execCommand
                            copySuccess = document.execCommand('copy');
                            document.body.removeChild(textArea);
                        } catch (e) {
                            console.log('execCommand не сработал:', e);
                        }
                    }
                    
                    if (copySuccess) {
                        // Если копирование удалось - показываем уведомление
                        shareDiaryBtn.innerHTML = '✅ Ссылка скопирована!';
                        alert(`✅ Ссылка на ваш дневник скопирована в буфер обмена!\n\n📋 Поделитесь этой ссылкой с диетологом\n\n⏰ Ссылка действительна в течение 30 дней`);
                    } else {
                        // Если копирование не удалось - показываем модальное окно
                        const shareUrl = result.share_url;
                        
                        const modal = document.createElement('div');
                        modal.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10000;
                            padding: 20px;
                            box-sizing: border-box;
                        `;
                        
                        modal.innerHTML = `
                            <div style="
                                background: white;
                                border-radius: 12px;
                                padding: 24px;
                                max-width: 400px;
                                width: 100%;
                                text-align: center;
                                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                            ">
                                <h3 style="margin: 0 0 16px 0; color: #333;">✅ Ссылка создана!</h3>
                                <p style="margin: 0 0 16px 0; color: #666; font-size: 14px;">
                                    Нажмите на ссылку, чтобы скопировать и отправьте диетологу в чате:
                                </p>
                                <div id="shareUrlBox" style="
                                    background: #f8f9fa;
                                    border: 1px solid #dee2e6;
                                    border-radius: 8px;
                                    padding: 12px;
                                    margin: 16px 0;
                                    word-break: break-all;
                                    font-size: 12px;
                                    color: #495057;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    user-select: all;
                                    -webkit-user-select: all;
                                " onclick="copyShareUrl(this, '${shareUrl}')" 
                                   onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#adb5bd';"
                                   onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#dee2e6';"
                                >${shareUrl}</div>
                                <p id="copyStatus" style="margin: 16px 0; color: #6c757d; font-size: 12px;">
                                    &nbsp;
                                </p>
                                <button onclick="this.parentElement.parentElement.remove()" style="
                                    background: #007bff;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    padding: 10px 20px;
                                    font-size: 14px;
                                    cursor: pointer;
                                ">Закрыть</button>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                        // Добавляем функцию копирования ссылки
                        window.copyShareUrl = async function(element, url) {
                            try {
                                let copySuccess = false;
                                
                                // Пробуем разные способы копирования
                                try {
                                    if (navigator.clipboard && window.isSecureContext) {
                                        await navigator.clipboard.writeText(url);
                                        copySuccess = true;
                                    }
                                } catch (e) {
                                    console.log('Clipboard API не сработал:', e);
                                }
                                
                                if (!copySuccess) {
                                    try {
                                        const textArea = document.createElement('textarea');
                                        textArea.value = url;
                                        textArea.style.position = 'fixed';
                                        textArea.style.left = '-999999px';
                                        textArea.style.top = '-999999px';
                                        document.body.appendChild(textArea);
                                        textArea.focus();
                                        textArea.select();
                                        copySuccess = document.execCommand('copy');
                                        document.body.removeChild(textArea);
                                    } catch (e) {
                                        console.log('execCommand не сработал:', e);
                                    }
                                }
                                
                                if (copySuccess) {
                                    // Показываем успешное копирование
                                    element.style.background = '#d4edda';
                                    element.style.borderColor = '#c3e6cb';
                                    element.style.color = '#155724';
                                    
                                    const statusElement = document.getElementById('copyStatus');
                                    statusElement.innerHTML = '✅ Ссылка скопирована в буфер обмена!';
                                    statusElement.style.color = '#28a745';
                                    
                                    // Возвращаем исходный вид через 2 секунды
                                    setTimeout(() => {
                                        element.style.background = '#f8f9fa';
                                        element.style.borderColor = '#dee2e6';
                                        element.style.color = '#495057';
                                        statusElement.innerHTML = '&nbsp;';
                                        statusElement.style.color = '#6c757d';
                                    }, 2000);
                                } else {
                                    // Если копирование не удалось - просто выделяем текст
                                    const range = document.createRange();
                                    range.selectNodeContents(element);
                                    const selection = window.getSelection();
                                    selection.removeAllRanges();
                                    selection.addRange(range);
                                    
                                    const statusElement = document.getElementById('copyStatus');
                                    statusElement.innerHTML = '📋 Ссылка выделена - скопируйте вручную (Ctrl+C)';
                                    statusElement.style.color = '#ffc107';
                                }
                                
                            } catch (error) {
                                console.error('Ошибка при копировании:', error);
                                
                                // В крайнем случае просто выделяем текст
                                const range = document.createRange();
                                range.selectNodeContents(element);
                                const selection = window.getSelection();
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        };
                        
                        shareDiaryBtn.innerHTML = '✅ Ссылка создана!';
                    }
                    
                    // Возвращаем кнопку в исходное состояние через 3 секунды
                    setTimeout(() => {
                        shareDiaryBtn.innerHTML = originalText;
                        shareDiaryBtn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Не удалось создать публичную ссылку');
                }
                
            } catch (error) {
                console.error('Ошибка при создании публичной ссылки:', error);
                
                // Восстанавливаем кнопку
                const shareDiaryBtn = document.getElementById('shareDiaryBtn');
                shareDiaryBtn.innerHTML = '📤 Поделиться дневником';
                shareDiaryBtn.disabled = false;
                
                // Показываем ошибку
                alert(`❌ Ошибка при создании ссылки: ${error.message}`);
            }
        }
        
        async function loadDiaryData(userId) {
            try {
                console.log('Загрузка дневника для пользователя:', userId);
                
                // Вычисляем дату для загрузки
                const targetDate = new Date();
                targetDate.setDate(targetDate.getDate() + currentDayOffset);
                const dateStr = targetDate.toISOString().split('T')[0];
                
                // Создаем экземпляр API клиента
                const apiClient = new TelegramBotApiClient();
                const diaryData = await apiClient.getDiary(userId, dateStr);
                
                // Отображаем данные
                await renderDiaryData(diaryData);
                
            } catch (error) {
                console.error('Ошибка при загрузке дневника:', error);
                document.getElementById('diary-content').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="color: #999; font-size: 48px; margin-bottom: 20px;"></i>
                        </div>
                        <h3 style="color: #333; margin: 0 0 30px 0; font-weight: 500;">Ошибка загрузки данных</h3>
                        <button onclick="location.reload()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            padding: 16px 32px;
                            font-size: 16px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: background-color 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            <i class="fas fa-sync-alt"></i>
                            Обновить страницу
                        </button>
                    </div>
                `;
            }
        }
           /**
         * Отображение данных дневника
         */
        async function renderDiaryData(data) {
            const container = document.getElementById('diary-content');
            
            // Форматируем дату для отображения
            const date = new Date(data.date);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let dateLabel = '';
            if (date.toDateString() === today.toDateString()) {
                dateLabel = 'Сегодня';
            } else if (date.toDateString() === yesterday.toDateString()) {
                dateLabel = 'Вчера';
            } else if (date.toDateString() === tomorrow.toDateString()) {
                dateLabel = 'Завтра';
            } else {
                dateLabel = date.toLocaleDateString('ru-RU', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            // Загружаем статус избранного для всех блюд
            const userId = getUserId();
            const favoritesStatus = {};
            
            if (data.meals && data.meals.length > 0) {
                try {
                    // Получаем статус избранного для всех блюд одним запросом
                    const favoriteChecks = await Promise.all(
                        data.meals.map(meal => 
                            fetch(`https://telegram-bot-api-h136.onrender.com/favorites/${userId}/check/${meal.id}`)
                                .then(response => response.ok ? response.json() : { meal_id: meal.id, is_favorite: false })
                                .catch(() => ({ meal_id: meal.id, is_favorite: false }))
                        )
                    );
                    
                    // Сохраняем статус в объект
                    favoriteChecks.forEach(check => {
                        favoritesStatus[check.meal_id] = check.is_favorite;
                    });
                    
                    console.log('Загружен статус избранного:', favoritesStatus);
                } catch (error) {
                    console.error('Ошибка загрузки статуса избранного:', error);
                }
            }
            
            // Добавляем статус избранного к каждому блюду
            if (data.meals) {
                data.meals.forEach(meal => {
                    meal.isFavorite = favoritesStatus[meal.id] || false;
                });
            }
            
            // Навигация по дням
            const isToday = currentDayOffset === 0;
            const rightButtonStyle = isToday 
                ? "background: rgba(150,150,150,0.4); border: none; color: rgba(255,255,255,0.6); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: not-allowed;"
                : "background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;";
            
            const navigationHtml = `
                <div class="date-navigator" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%); border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(122, 155, 142, 0.3);">
                    <button onclick="navigateDay(-1)" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        ‹
                    </button>
                    <h3 style="margin: 0; font-weight: 600; text-align: center;">${dateLabel}</h3>
                    <button onclick="navigateDay(1)" style="${rightButtonStyle}">
                        ›
                    </button>
                </div>
            `;
            
            // Панель с общей информацией
            const caloriesPercent = Math.round((data.total_calories / data.targets.calories) * 100);
            const proteinPercent = Math.round((data.total_protein / data.targets.protein) * 100);
            const fatPercent = Math.round((data.total_fat / data.targets.fat) * 100);
            const carbPercent = Math.round((data.total_carb / data.targets.carb) * 100);
            const fiberPercent = Math.round((data.total_fiber / data.targets.fiber) * 100);
            
            const summaryHtml = `
                <div class="card" style="background: linear-gradient(135deg, #7a9b8e 0%, #6b8b7d 100%); color: white; border: none; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(122, 155, 142, 0.3);">
                    <div class="card-header" style="background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid rgba(255, 255, 255, 0.2); color: white;">
                        <h5 class="mb-0">📊 Общая информация</h5>
                    </div>
                    <div class="card-body">
                        <!-- Круговая диаграмма калорий -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="position: relative; display: inline-block;">
                                <svg width="120" height="120" style="transform: rotate(-90deg);">
                                    <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="8"/>
                                    <circle cx="60" cy="60" r="50" fill="none" stroke="white" stroke-width="8" 
                                            stroke-dasharray="${2 * Math.PI * 50}" 
                                            stroke-dashoffset="${2 * Math.PI * 50 * (1 - Math.min(caloriesPercent / 100, 1))}"
                                            style="transition: stroke-dashoffset 0.5s ease;"/>
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 1.2rem; font-weight: 700;">${data.total_calories}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">из ${data.targets.calories}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.8;">ккал</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Прогресс-бары БЖУ -->
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Белки: ${data.total_protein}г / ${data.targets.protein}г</div>
                                <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: white; height: 100%; width: ${Math.min(proteinPercent, 100)}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 2px;">${proteinPercent}%</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Жиры: ${data.total_fat}г / ${data.targets.fat}г</div>
                                <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: white; height: 100%; width: ${Math.min(fatPercent, 100)}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 2px;">${fatPercent}%</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Углеводы: ${data.total_carb}г / ${data.targets.carb}г</div>
                                <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: white; height: 100%; width: ${Math.min(carbPercent, 100)}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 2px;">${carbPercent}%</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div style="font-size: 0.9rem; margin-bottom: 5px;">Клетчатка: ${data.total_fiber}г / ${data.targets.fiber}г</div>
                                <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: white; height: 100%; width: ${Math.min(fiberPercent, 100)}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 2px;">${fiberPercent}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Приемы пищи
            let mealsHtml = '';
            if (data.meals && data.meals.length > 0) {
                mealsHtml = `
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">🍽️ Приемы пищи</h5>
                        </div>
                        <div class="card-body">
                `;
                
                data.meals.forEach(meal => {
                    // Отладочная информация для изображений
                    console.log(`Meal ${meal.id}: image = ${meal.image ? 'есть' : 'нет'}`);
                    
                    // Создаем HTML для изображения или плейсхолдера
                    let imageHtml = '';
                    if (meal.image && meal.image.trim() !== '') {
                        imageHtml = `
                            <img src="data:image/jpeg;base64,${meal.image}" 
                                 alt="Фото блюда" 
                                 class="meal-image" 
                                 onclick="showImageModal('${meal.image}')"
                                 title="Нажмите для увеличения"
                                 onerror="console.error('Ошибка загрузки изображения для приема пищи ${meal.id}')">
                        `;
                    } else {
                        imageHtml = `
                            <div class="meal-image-placeholder">
                                🍽️
                            </div>
                        `;
                    }
                    
                    mealsHtml += `
                        <div class="meal-item" style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--tg-theme-button-color, #4d6073);">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start" style="flex: 1;">
                                    ${imageHtml}
                                    <div style="flex: 1;">
                                        <div class="meal-time" style="font-weight: 600; color: var(--tg-theme-button-color, #4d6073); font-size: 0.9rem;">${meal.time}</div>
                                        <div class="meal-description" style="margin: 5px 0; color: #333;">${meal.description}</div>
                                        <div class="meal-calories" style="font-size: 0.9rem; color: #666;">
                                            ${meal.calories} ккал • Б: ${meal.protein}г • Ж: ${meal.fat}г • У: ${meal.carb}г
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start" style="gap: 8px;">
                                    <button class="btn btn-sm ${meal.isFavorite ? 'btn-warning' : 'btn-outline-warning'}" 
                                            onclick="toggleFavorite(${meal.id})" 
                                            id="favorite-btn-${meal.id}"
                                            title="${meal.isFavorite ? 'Убрать из избранного' : 'Добавить в избранное'}"
                                            style="min-width: 40px;">
                                        ${meal.isFavorite ? '⭐' : '☆'}
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleMealDetails(${meal.id})">
                                        Детали
                                    </button>
                                </div>
                            </div>
                            <div id="meal-details-${meal.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                <h6>Состав:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Продукт</th>
                                                <th>Вес</th>
                                                <th>Калории</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    if (meal.items && meal.items.length > 0) {
                        meal.items.forEach(item => {
                            mealsHtml += `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.weight}</td>
                                    <td>${item.calories} ккал</td>
                                </tr>
                            `;
                        });
                    } else {
                        mealsHtml += `
                            <tr>
                                <td colspan="3" class="text-muted">Детальная информация недоступна</td>
                            </tr>
                        `;
                    }
                    
                    mealsHtml += `
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMeal('${meal.timestamp}', ${meal.id})" style="border-radius: 20px;">
                                        🗑️ Удалить блюдо
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                mealsHtml += `
                        </div>
                    </div>
                `;
            } else {
                mealsHtml = `
                    <div class="card" style="background: #f8f9fa; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
                        <div class="card-body text-center">
                            <div class="empty-icon" style="font-size: 48px; margin-bottom: 16px; color: #6c757d;">🍽️</div>
                            <h5 style="color: #495057;">Нет записей о питании</h5>
                            <p style="color: #6c757d;">В этот день не было добавлено ни одного блюда.</p>
                        </div>
                    </div>
                `;
            }
            
            // Сообщение отладки (если есть)
            let debugMessage = '';
            if (data.message) {
                debugMessage = `
                    <div class="alert alert-info" style="margin-bottom: 20px; color: #6c757d !important;">
                        <i class="fas fa-info-circle" style="color: #6c757d !important;"></i> ${data.message}
                    </div>
                `;
            }
            
            container.innerHTML = navigationHtml + debugMessage + summaryHtml + mealsHtml;
        }
        
        /**
         * Навигация по дням
         */
        function navigateDay(direction) {
            // Запрещаем переход в будущее (direction = 1) когда уже на сегодняшнем дне
            if (direction === 1 && currentDayOffset === 0) {
                console.log('Переход в будущее запрещен');
                return;
            }
            
            currentDayOffset += direction;
            loadDiaryData(getUserId());
        }
        
        /**
         * Переключение отображения деталей приема пищи
         */
        function toggleMealDetails(mealId) {
            const detailsElement = document.getElementById(`meal-details-${mealId}`);
            if (detailsElement) {
                detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
            }
        }

        /**
         * Удаление блюда
         */
        async function deleteMeal(timestamp, mealId) {
            const userId = getUserId();
            if (!userId) {
                alert('Ошибка: не удалось получить ID пользователя');
                return;
            }

            // Подтверждение удаления
            if (!confirm('Вы уверены, что хотите удалить это блюдо? Действие нельзя отменить.')) {
                return;
            }

            try {
                // Создаем экземпляр API клиента
                const apiClient = new TelegramBotApiClient();
                
                // Отправляем DELETE запрос
                const response = await fetch(`${apiClient.apiBaseUrl}/meal/${userId}/${encodeURIComponent(timestamp)}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiClient.apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'success') {
                    // Очищаем клиентский кэш
                    dataCache.clear();
                    
                    // Дополнительно очищаем серверный кэш через API
                    try {
                        await fetch(`${apiClient.apiBaseUrl}/cache/clear/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-API-Key': apiClient.apiKey
                            }
                        });
                    } catch (e) {
                        console.log('Ошибка очистки серверного кэша:', e.message);
                    }
                    
                    // Показываем уведомление об успешном удалении
                    alert('✅ Блюдо успешно удалено!');
                    
                    // Перезагружаем данные
                    await loadDiaryData(userId);
                    
                    // Также обновляем статистику, если она загружена
                    if (document.getElementById('stats-section').style.display !== 'none') {
                        await loadStatsData(userId);
                    }
                } else {
                    throw new Error(result.message || 'Неизвестная ошибка');
                }
            } catch (error) {
                console.error('Ошибка при удалении блюда:', error);
                alert('❌ Ошибка при удалении блюда: ' + error.message);
            }
        }

        async function loadRecipesData(userId) {
            // Реализация загрузки избранных блюд (оставляем как есть)
            console.log('Загрузка избранных блюд для пользователя:', userId);
        }

        // Глобальные переменные для навигации по неделям
        let currentWeekOffset = 0;
        
        /**
         * Навигация по неделям
         */
        function navigateWeek(direction) {
            // Запрещаем переход в будущее (direction = 1) когда уже на текущем периоде
            if (direction === 1 && currentWeekOffset === 0) {
                console.log('Переход в будущее запрещен');
                return;
            }
            
            currentWeekOffset += direction;
            updateWeekDisplay();
            loadStatsData(getUserId());
        }
        
        /**
         * Обновление отображения недели (скользящие 7 дней)
         */
        function updateWeekDisplay() {
            const weekRange = document.getElementById('weekRange');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            if (!weekRange) return;
            
            // Используем ту же логику что и в generateWeekDates
            const endDate = new Date(); // Сегодня - это конечная дата
            endDate.setDate(endDate.getDate() + (currentWeekOffset * 7));
            
            const startDate = new Date(endDate);
            startDate.setDate(endDate.getDate() - 6); // 6 дней назад от конечной даты
            
            const formatDate = (date) => {
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            };
            
            if (currentWeekOffset === 0) {
                weekRange.textContent = 'Последние 7 дней';
            } else {
                weekRange.textContent = `${formatDate(startDate)} - ${formatDate(endDate)}`;
            }
            
            // Управляем видимостью кнопки "следующая неделя"
            if (nextWeekBtn) {
                if (currentWeekOffset === 0) {
                    // На текущем периоде - делаем кнопку неактивной с улучшенным дизайном
                    nextWeekBtn.style.background = 'rgba(150,150,150,0.4)';
                    nextWeekBtn.style.color = 'rgba(255,255,255,0.6)';
                    nextWeekBtn.style.cursor = 'not-allowed';
                    nextWeekBtn.disabled = true;
                } else {
                    // На прошлых периодах - кнопка активна
                    nextWeekBtn.style.background = 'rgba(255,255,255,0.2)';
                    nextWeekBtn.style.color = 'white';
                    nextWeekBtn.style.cursor = 'pointer';
                    nextWeekBtn.disabled = false;
                }
            }
            
            console.log(`Обновлена подпись недели (offset=${currentWeekOffset}): ${weekRange.textContent}`);
        }
        
        /**
         * Отображение статистики с графиками
         */
        async function renderStatsWithCharts(statsData) {
            // Отладочное логирование удалено для оптимизации
            const statsContent = document.getElementById('stats-content');
            
            // Генерируем данные для недели на основе данных из дневника
            const weekDates = generateWeekDates(currentWeekOffset);
            const weekData = await generateWeekData(weekDates, statsData, getUserId());
            
            statsContent.innerHTML = `
                <style>
                .macro-card {
                    background-color: #fff;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    padding: 20px 0;
                    margin: 20px -20px;
                    border: 1px solid rgba(0, 0, 0, 0.05);
                }
                .macro-card h3 {
                    color: #333;
                    margin-bottom: 15px;
                    font-weight: 600;
                    font-size: 1.2rem;
                    padding: 0 20px;
                }
                .macro-card p {
                    color: #666;
                    margin-bottom: 15px;
                    font-size: 0.9rem;
                    padding: 0 20px;
                }
                .macro-card canvas {
                    height: 200px !important;
                    width: 100% !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
                </style>
                
                <!-- Карточки с графиками -->
                <div class="macro-card">
                    <h3>Калории 🔥 <small style="font-size: 13px;">Цель: ${statsData.user_targets?.calories || 2000} ккал</small></h3>
                    <p>Среднее значение в день: <strong>${Math.round(weekData.calories.reduce((a, b) => a + b, 0) / 7)} ккал</strong></p>
                    <canvas id="caloriesChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>Белки 💪 <small style="font-size: 13px;">Цель: ${statsData.user_targets?.protein || 100} г.</small></h3>
                    <p>Среднее значение в день: <strong>${Math.round(weekData.proteins.reduce((a, b) => a + b, 0) / 7)} г</strong></p>
                    <canvas id="proteinsChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>Жиры 🧈 <small style="font-size: 13px;">Цель: ${statsData.user_targets?.fat || 67} г.</small></h3>
                    <p>Среднее значение в день: <strong>${Math.round(weekData.fats.reduce((a, b) => a + b, 0) / 7)} г</strong></p>
                    <canvas id="fatsChart"></canvas>
                </div>

                <div class="macro-card">
                    <h3>Углеводы 🍞 <small style="font-size: 13px;">Цель: ${statsData.user_targets?.carb || 250} г.</small></h3>
                    <p>Среднее значение в день: <strong>${Math.round(weekData.carbs.reduce((a, b) => a + b, 0) / 7)} г</strong></p>
                    <canvas id="carbsChart"></canvas>
                </div>

                <div class="macro-card" style="margin-bottom: 30px;">
                    <h3>Клетчатка 🌾 <small style="font-size: 13px;">Цель: ${statsData.user_targets?.fiber || 25} г</small></h3>
                    <p>Среднее значение в день: <strong>${Math.round(weekData.fiber.reduce((a, b) => a + b, 0) / 7)} г</strong></p>    
                    <canvas id="fiberChart"></canvas>
                </div>
            `;
            
            // Создаем графики
            setTimeout(() => {
                createCharts(weekDates, weekData, statsData.user_targets);
                // Обновляем отображение кнопок навигации после создания контента
                updateWeekDisplay();
            }, 100);
        }
        
        /**
         * Генерация дат для недели (скользящие 7 дней от текущей даты)
         */
        function generateWeekDates(weekOffset) {
            const dates = [];
            const endDate = new Date(); // Сегодня - это конечная дата
            
            // Сдвигаем конечную дату на weekOffset * 7 дней
            endDate.setDate(endDate.getDate() + (weekOffset * 7));
            
            // Генерируем 7 дней назад от конечной даты
            for (let i = 6; i >= 0; i--) {
                const date = new Date(endDate);
                date.setDate(endDate.getDate() - i);
                // Возвращаем даты в формате DD.MM.YYYY для совместимости с daily_data
                dates.push(date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }));
            }
            
            console.log(`Сгенерированные даты (скользящие 7 дней, offset=${weekOffset}):`, dates);
            return dates;
        }
        
          /**
         * Генерация данных для недели на основе данных из статистики
         */
        async function generateWeekData(dates, statsData, userId) {
            // Отладочное логирование удалено для оптимизации
            
            // Создаем массивы для каждого макронутриента
            const calories = [];
            const proteins = [];
            const fats = [];
            const carbs = [];
            const fiber = [];
            
            // Используем данные из statsData.daily_data вместо запросов к API
            if (statsData.daily_data && statsData.daily_data.length > 0) {
                // Отладочное логирование удалено для оптимизации
                
                // Создаем карту дат для быстрого поиска
                const dataMap = {};
                for (const dayData of statsData.daily_data) {
                    dataMap[dayData.date] = dayData;
                }
                
                // Получаем данные для каждой даты недели
                for (const date of dates) {
                    const dayData = dataMap[date];
                    if (dayData) {
                        // Отладочное логирование удалено для оптимизации
                        calories.push(Math.round(dayData.calories || 0));
                        proteins.push(Math.round(dayData.protein || 0));
                        fats.push(Math.round(dayData.fat || 0));
                        carbs.push(Math.round(dayData.carb || 0));
                        fiber.push(Math.round(dayData.fiber || 0));
                    } else {
                        // Отладочное логирование удалено для оптимизации
                        calories.push(0);
                        proteins.push(0);
                        fats.push(0);
                        carbs.push(0);
                        fiber.push(0);
                    }
                }
            } else {
                // Отладочное логирование удалено для оптимизации
                // Если нет данных - заполняем нулями
                for (let i = 0; i < 7; i++) {
                    calories.push(0);
                    proteins.push(0);
                    fats.push(0);
                    carbs.push(0);
                    fiber.push(0);
                }
            }
            
            // Отладочное логирование удалено для оптимизации
            
            return {
                calories: calories,
                proteins: proteins,
                fats: fats,
                carbs: carbs,
                fiber: fiber
            };
        }
        
        /**
         * Создание графиков в стиле Apple Health (точная копия)
         */
        function createCharts(dates, data, targets) {
            // Проверяем, что Chart.js загружен
            if (!window.Chart) {
                console.error('Chart.js не загружен! Графики не могут быть созданы.');
                return;
            }
            
            // Настройка глобальных параметров Chart.js для лучшего отображения шрифтов
            Chart.defaults.font.family = 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
            Chart.defaults.font.weight = '400';
            Chart.defaults.font.lineHeight = 1.2;
            
            // Преобразуем даты в дни недели
            const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            const weekDays = dates.map(dateStr => {
                // Парсим дату в формате DD.MM.YYYY
                const [day, month, year] = dateStr.split('.');
                const date = new Date(year, month - 1, day);
                return dayNames[date.getDay()];
            });
            
            console.log('Исходные даты:', dates);
            console.log('Дни недели для подписей:', weekDays);
            console.log('Целевые значения для линий:', targets);
            
            // Создаем красивый градиент с плавными переходами между зонами
            const createHealthGradient = (canvasCtx, chartHeight) => {
                const gradient = canvasCtx.createLinearGradient(0, 0, 0, chartHeight);
                
                // Красивые цвета с плавными переходами
                gradient.addColorStop(0.0, '#E74C3C');    // Красивый красный (выше 100%)
                gradient.addColorStop(0.1, '#E67E22');    // Оранжево-красный переход
                gradient.addColorStop(0.15, '#F39C12');   // Оранжевый (100%)
                gradient.addColorStop(0.75, '#F1C40F');   // Желтый (85-100%)
                gradient.addColorStop(0.85, '#7a9b8e');   // Корпоративный зеленый переход
                gradient.addColorStop(1.0, '#7a9b8e');    // Корпоративный зеленый (до 85%)
                
                return gradient;
            };
            
            const config = [
                {
                    element: 'caloriesChart',
                    data: data.calories,
                    targetValue: targets?.calories || 2000,
                    icon: '🔥'
                },
                {
                    element: 'proteinsChart',
                    data: data.proteins,
                    targetValue: targets?.protein || 100,
                    icon: '💪'
                },
                {
                    element: 'fatsChart',
                    data: data.fats,
                    targetValue: targets?.fat || 67,
                    icon: '🧈'
                },
                {
                    element: 'carbsChart',
                    data: data.carbs,
                    targetValue: targets?.carb || 250,
                    icon: '🍞'
                },
                {
                    element: 'fiberChart',
                    data: data.fiber,
                    targetValue: targets?.fiber || 25,
                    icon: '🌾'
                }
            ];

            config.forEach(function(chartConfig) {
                const ctx = document.getElementById(chartConfig.element);
                if (!ctx) return;
                
                const canvasCtx = ctx.getContext('2d');
                
                // Создаем индивидуальные градиенты для каждого столбца
                const backgroundColors = chartConfig.data.map((value, index) => {
                    const percentage = (value / chartConfig.targetValue) * 100;
                    
                    // Создаем градиент для каждого столбца (от верха к низу)
                    const gradient = canvasCtx.createLinearGradient(0, 0, 0, 400);
                    
                    if (percentage <= 85) {
                        // Случай 1: До 85% - полностью зеленый столбец
                        gradient.addColorStop(0, '#7a9b8e');
                        gradient.addColorStop(1, '#7a9b8e');
                        
                    } else if (percentage <= 100) {
                        // Случай 2: 85-100% - зеленый снизу, желтый сверху
                        gradient.addColorStop(0, '#F1C40F');      // Верх - желтый
                        gradient.addColorStop(0.2, '#F1C40F');    // 20% желтого сверху
                        gradient.addColorStop(0.3, '#7a9b8e');    // Переход к зеленому
                        gradient.addColorStop(1, '#7a9b8e');      // 70% зеленого снизу
                        
                    } else {
                        // Случай 3: Выше 100% - красный сверху, желтый в середине, зеленый снизу
                        const greenPortion = 85 / percentage;    // Доля зеленого (до 85%)
                        const yellowPortion = 15 / percentage;   // Доля желтого (85-100%)
                        
                        gradient.addColorStop(0, '#E74C3C');                           // Верх - красный
                        gradient.addColorStop(1 - greenPortion - yellowPortion, '#E74C3C'); // Красная зона
                        gradient.addColorStop(1 - greenPortion - yellowPortion + 0.05, '#F1C40F'); // Переход к желтому
                        gradient.addColorStop(1 - greenPortion, '#F1C40F');            // Желтая зона
                        gradient.addColorStop(1 - greenPortion + 0.05, '#7a9b8e');     // Переход к зеленому
                        gradient.addColorStop(1, '#7a9b8e');                          // Зеленая зона
                    }
                    
                    return gradient;
                });
                
                // Создаем массив с целевым значением для каждого дня
                const targetLine = new Array(weekDays.length).fill(chartConfig.targetValue);
                
                new Chart(canvasCtx, {
                    type: 'bar',
                    data: {
                        labels: weekDays,
                        datasets: [
                            {
                                type: 'bar',
                                label: 'Данные',
                                data: chartConfig.data,
                                backgroundColor: backgroundColors,
                                borderColor: 'transparent',
                                borderWidth: 0,
                                borderRadius: 4,
                                borderSkipped: false,
                                barThickness: 16,
                                categoryPercentage: 1.0,
                                barPercentage: 0.6
                            },
                            {
                                type: 'line',
                                label: 'Цель',
                                data: targetLine,
                                borderColor: '#98989D',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 0,
                                pointHoverRadius: 0,
                                fill: false,
                                tension: 0,
                                borderDash: [6, 6]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        animation: {
                            duration: 750,
                            easing: 'easeInOutQuart'
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 5,
                                left: 0,
                                right: 0
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: true,
                                    drawBorder: false,
                                    color: 'rgba(152, 152, 157, 0.3)',
                                    borderDash: [2, 2],
                                    lineWidth: 1
                                },
                                border: {
                                    display: false
                                },
                                ticks: {
                                    color: '#8E8E93',
                                    font: {
                                        size: window.innerWidth < 768 ? 14 : 16,
                                        weight: '400',
                                        family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                    },
                                    maxRotation: 0,
                                    padding: 15,
                                    textStrokeColor: 'transparent',
                                    textStrokeWidth: 0
                                }
                            },
                            y: {
                                beginAtZero: true,
                                position: 'right',
                                border: {
                                    display: false
                                },
                                grid: {
                                    color: 'rgba(152, 152, 157, 0.2)',
                                    borderDash: [],
                                    lineWidth: 1,
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#8E8E93',
                                    font: {
                                        size: window.innerWidth < 768 ? 13 : 15,
                                        weight: '400',
                                        family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                    },
                                    padding: 15,
                                    maxTicksLimit: 4,
                                    textStrokeColor: 'transparent',
                                    textStrokeWidth: 0,
                                    callback: function(value) {
                                        // Форматируем числа как в Apple (с пробелами для тысяч)
                                        return Math.round(value).toLocaleString('ru-RU');
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(28, 28, 30, 0.95)',
                                titleColor: '#FFFFFF',
                                bodyColor: '#FFFFFF',
                                borderColor: 'transparent',
                                borderWidth: 0,
                                cornerRadius: 16,
                                displayColors: false,
                                titleFont: {
                                    size: window.innerWidth < 768 ? 15 : 17,
                                    weight: '500',
                                    family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                },
                                bodyFont: {
                                    size: window.innerWidth < 768 ? 14 : 16,
                                    weight: '400',
                                    family: 'Manrope, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif'
                                },
                                padding: 20,
                                caretSize: 10,
                                callbacks: {
                                    title: function(context) {
                                        return `${chartConfig.icon} ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            const percentage = Math.round((context.parsed.y / chartConfig.targetValue) * 100);
                                            return `${context.parsed.y} (${percentage}% от цели)`;
                                        } else {
                                            return `Цель: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        // Функция для отображения изображения в модальном окне
        function showImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            
            modalImg.src = `data:image/jpeg;base64,${imageSrc}`;
            modal.style.display = 'block';
        }

        // Инициализация обработчиков модального окна
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('imageModal');
            const closeBtn = document.querySelector('.image-modal-close');
            const modalImg = document.getElementById('modalImage');
            
            // Закрытие по клику на крестик
            if (closeBtn) {
                closeBtn.onclick = function(event) {
                    event.stopPropagation();
                    modal.style.display = 'none';
                }
            }
            
            // Закрытие по клику на изображение
            if (modalImg) {
                modalImg.onclick = function(event) {
                    event.stopPropagation();
                    modal.style.display = 'none';
                }
            }
            
            // Закрытие по клику на фон модального окна
            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        });

        // ==================== ФУНКЦИИ ДЛЯ РАБОТЫ С ВЕСОМ ====================

        let currentWeightPeriod = 'month';
        let weightChart = null;

        /**
         * Загрузка данных о весе
         */
        async function loadWeightData(userId, period = 'month') {
            const weightContent = document.getElementById('weight-content');
            
            try {
                const apiClient = new TelegramBotApiClient();
                
                // Принудительно очищаем кэш перед загрузкой новых данных
                const cacheKeys = [
                    `weight_${userId}_week`,
                    `weight_${userId}_month`,
                    `weight_${userId}_6months`,
                    `weight_${userId}_year`,
                    `profile_${userId}`
                ];
                cacheKeys.forEach(key => dataCache.delete(key));
                
                const weightData = await apiClient.getWeightHistory(userId, period);
                
                
                renderWeightData(weightData, period);
                
            } catch (error) {
                console.error('Ошибка загрузки данных о весе:', error);
                weightContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle" style="color: #999; font-size: 48px; margin-bottom: 20px;"></i>
                        </div>
                        <h3 style="color: #333; margin: 0 0 30px 0; font-weight: 500;">Ошибка загрузки данных о весе</h3>
                        <button onclick="location.reload()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 12px;
                            padding: 16px 32px;
                            font-size: 16px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: background-color 0.2s ease;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                        " onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            <i class="fas fa-sync-alt"></i>
                            Обновить страницу
                        </button>
                    </div>
                `;
            }
        }

        /**
         * Отображение данных о весе
         */
        function renderWeightData(data, period) {
            
            const weightContent = document.getElementById('weight-content');
            const entries = data.entries || [];
            const currentWeight = data.current_weight;
            const goalWeight = data.goal_weight;
            const weightChange = data.weight_change;

            // Карточка с текущим весом
            let weightCardHtml = `
                <div class="weight-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="weight-current">${currentWeight ? currentWeight + ' кг' : 'Не указан'}</div>
                            ${weightChange ? `
                                <div class="weight-change ${weightChange > 0 ? 'positive' : 'negative'}">
                                    ${weightChange > 0 ? '+' : ''}${weightChange} кг за период
                                </div>
                            ` : ''}
                            ${goalWeight ? `
                                <div class="weight-goal">
                                    Цель: ${goalWeight} кг
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            <i class="fas fa-weight" style="font-size: 2rem; opacity: 0.7;"></i>
                        </div>
                    </div>
                </div>
            `;

            // Кнопка добавления веса
            let addButtonHtml = `
                <button class="add-weight-btn" data-bs-toggle="modal" data-bs-target="#addWeightModal">
                    <i class="fas fa-plus me-2"></i>Добавить новый вес
                </button>
            `;

            // Селектор периода
            let periodSelectorHtml = `
                <div class="period-selector">
                    <button class="period-btn ${period === 'week' ? 'active' : ''}" onclick="changeWeightPeriod('week')">Неделя</button>
                    <button class="period-btn ${period === 'month' ? 'active' : ''}" onclick="changeWeightPeriod('month')">Месяц</button>
                    <button class="period-btn ${period === '6months' ? 'active' : ''}" onclick="changeWeightPeriod('6months')">6 мес</button>
                    <button class="period-btn ${period === 'year' ? 'active' : ''}" onclick="changeWeightPeriod('year')">Год</button>
                </div>
            `;

            // Контейнер для графика
            let chartHtml = `
                <div class="weight-chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            `;

            // Таблица истории
            let historyHtml = `
                <div class="weight-history-table">
                    <div class="weight-history-header">
                        <i class="fas fa-history me-2"></i>История веса
                    </div>
            `;

            if (entries.length > 0) {
                // Сортируем записи по timestamp в обратном порядке (новые сверху)
                const sortedEntries = [...entries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                sortedEntries.forEach((entry, index) => {
                    // Проверяем что у записи есть валидный вес
                    if (!entry.weight || entry.weight === null || entry.weight === undefined) {
                        return; // Пропускаем записи с null весом
                    }
                    
                    const entryDate = new Date(entry.date).toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric'
                    });
                    
                    // Определяем является ли запись последней (самой новой)
                    const isLatestEntry = index === 0; // entries уже отсортированы по убыванию даты
                    
                    let changeHtml = '';
                    if (index < entries.length - 1) {
                        const prevWeight = entries[index + 1].weight;
                        if (prevWeight && prevWeight !== null) {
                            const change = entry.weight - prevWeight;
                            if (Math.abs(change) >= 0.1) {
                                changeHtml = `
                                    <span class="weight-entry-change ${change > 0 ? 'positive' : 'negative'}">
                                        ${change > 0 ? '+' : ''}${change.toFixed(1)} кг
                                    </span>
                                `;
                            }
                        }
                    }
                    
                    // Подсказка для кнопки удаления
                    const deleteTooltip = isLatestEntry 
                        ? "Удалить запись и вернуть вес к предыдущему значению"
                        : "Удалить запись из истории";
                    
                    historyHtml += `
                        <div class="weight-entry">
                            <div>
                                <div class="weight-entry-date">${entryDate}</div>
                                ${entry.note ? `<small class="text-muted">${entry.note}</small>` : ''}
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="weight-entry-value">${entry.weight} кг</span>
                                ${changeHtml}
                                <button class="weight-entry-delete" onclick="deleteWeightEntry('${entry.timestamp}', ${isLatestEntry})" title="${deleteTooltip}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            } else {
                historyHtml += `
                    <div class="weight-entry">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-weight fa-2x mb-2 d-block" style="opacity: 0.3;"></i>
                            Нет записей о весе
                        </div>
                    </div>
                `;
            }

            historyHtml += `</div>`;

            weightContent.innerHTML = weightCardHtml + addButtonHtml + periodSelectorHtml + chartHtml + historyHtml;
            
            
            // Создаем график после добавления HTML
            setTimeout(() => {
                createWeightChart(entries, goalWeight);
            }, 100);
        }
        
        /**
         * Удаление записи веса через API
         * @param {string} timestamp - Временная метка записи для удаления
         * @param {boolean} isLatestEntry - Является ли запись последней
         */
        async function deleteWeightEntry(timestamp, isLatestEntry) {
            // Показываем подтверждение
            const confirmMessage = isLatestEntry 
                ? "Удалить последнюю запись веса? Текущий вес будет изменен на предыдущее значение."
                : "Удалить эту запись веса из истории?";
                
            if (!confirm(confirmMessage)) {
                return; // Пользователь отменил удаление
            }
            
            try {
                // Показываем индикатор загрузки
                const weightContent = document.getElementById('weight-content');
                if (weightContent) {
                    weightContent.style.opacity = '0.6';
                    weightContent.style.pointerEvents = 'none';
                }
                
                const userId = getUserId();
                const apiClient = new TelegramBotApiClient();
                
                
                // Вызываем API для удаления записи
                const result = await apiClient.deleteWeightEntry(userId, timestamp);
                
                
                if (result.success) {
                    
                    // Принудительно очищаем кэш
                    const cacheKeys = [
                        `weight_${userId}_week`,
                        `weight_${userId}_month`,
                        `weight_${userId}_6months`,
                        `weight_${userId}_year`,
                        `profile_${userId}`
                    ];
                    cacheKeys.forEach(key => dataCache.delete(key));
                    
                    // Перезагружаем данные о весе с текущим периодом
                    await loadWeightData(userId, currentWeightPeriod);
                    
                    
                    // Показываем уведомление об успехе
                    const message = result.data?.is_latest_entry && result.data?.restored_weight
                        ? `Запись удалена. Текущий вес обновлен на ${result.data.restored_weight} кг.`
                        : "Запись удалена из истории.";
                    alert(message);
                } else {
                    alert("Ошибка при удалении записи: " + (result.error || "неизвестная ошибка"));
                }
                
            } catch (error) {
                console.error('DEBUG: Ошибка в deleteWeightEntry:', error);
                alert("Ошибка при удалении записи: " + error.message);
            } finally {
                // Восстанавливаем отображение
                const weightContent = document.getElementById('weight-content');
                if (weightContent) {
                    weightContent.style.opacity = '1';
                    weightContent.style.pointerEvents = 'auto';
                }
            }
        }        
        /**
         * Создание графика веса
         */
        function createWeightChart(entries, goalWeight) {
            const ctx = document.getElementById('weightChart');
            if (!ctx) return;

            // Уничтожаем предыдущий график если есть
            if (weightChart) {
                weightChart.destroy();
            }

            if (entries.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                const container = ctx.parentElement;
                container.innerHTML = `
                    <div class="chart-placeholder">
                        <i class="fas fa-chart-line"></i>
                        <p>Недостаточно данных для графика</p>
                        <small class="text-muted">Добавьте несколько записей веса</small>
                    </div>
                `;
                return;
            }

            // Подготавливаем данные для графика
            // Сортируем по timestamp, чтобы новые записи были справа
            const sortedEntries = [...entries].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const labels = sortedEntries.map(entry => {
                const date = new Date(entry.date);
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            });
            const weights = sortedEntries.map(entry => entry.weight);

            // Линия цели
            const goalLine = goalWeight ? new Array(weights.length).fill(goalWeight) : [];

            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Вес',
                            data: weights,
                            borderColor: '#7a9b8e',
                            backgroundColor: 'rgba(122, 155, 142, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#7a9b8e',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            fill: true,
                            tension: 0.4
                        },
                        ...(goalWeight ? [{
                            label: 'Цель',
                            data: goalLine,
                            borderColor: '#ff6b6b',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            fill: false,
                            tension: 0,
                            borderDash: [6, 6]
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                },
                                callback: function(value) {
                                    return value + ' кг';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: goalWeight ? true : false,
                            position: 'top',
                            labels: {
                                color: '#6c757d',
                                font: {
                                    size: 12,
                                    family: 'Manrope'
                                },
                                usePointStyle: true,
                                pointStyle: 'line'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#7a9b8e',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' кг';
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Изменение периода просмотра веса
         */
        function changeWeightPeriod(period) {
            currentWeightPeriod = period;
            loadWeightData(getUserId(), period);
        }

        /**
         * Добавление нового веса
         */
        async function addWeight(userId, weight, note = '') {
            try {
                const apiClient = new TelegramBotApiClient();
                const result = await apiClient.addWeightEntry(userId, {
                    weight: parseFloat(weight),
                    note: note
                });

                // Показываем уведомление
                let message = 'Вес успешно добавлен';
                if (result.data && result.data.targets_recalculated) {
                    message += ' и целевые значения пересчитаны';
                }
                showToast(message);

                // Очищаем кэш
                const cacheKeys = [
                    `profile_${userId}`,
                    `weight_${userId}`,
                    `stats_${userId}`
                ];
                cacheKeys.forEach(key => dataCache.delete(key));

                // Перезагружаем данные
                loadWeightData(userId, currentWeightPeriod);

                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addWeightModal'));
                if (modal) {
                    modal.hide();
                }

                // Очищаем форму
                document.getElementById('addWeightForm').reset();

            } catch (error) {
                console.error('Ошибка добавления веса:', error);
                showToast('Ошибка при добавлении веса: ' + error.message, 'error');
            }
        }
        
        // Функции для работы с избранным
        async function toggleFavorite(mealId) {
            try {
                const userId = getUserId();
                console.log(`Переключение избранного для блюда ${mealId}`);
                
                // Получаем текущее состояние кнопки
                const favoriteBtn = document.getElementById(`favorite-btn-${mealId}`);
                const isFavorite = favoriteBtn.classList.contains('btn-warning');
                
                // Отправляем запрос на сервер
                const response = await fetch(`https://telegram-bot-api-h136.onrender.com/favorites/${userId}`, {
                    method: isFavorite ? 'DELETE' : 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ meal_id: mealId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Обновляем UI
                if (isFavorite) {
                    // Убираем из избранного
                    favoriteBtn.classList.remove('btn-warning');
                    favoriteBtn.classList.add('btn-outline-warning');
                    favoriteBtn.innerHTML = '☆';
                    favoriteBtn.title = 'Добавить в избранное';
                    showToast('Блюдо убрано из избранного', 'success');
                } else {
                    // Добавляем в избранное
                    favoriteBtn.classList.remove('btn-outline-warning');
                    favoriteBtn.classList.add('btn-warning');
                    favoriteBtn.innerHTML = '⭐';
                    favoriteBtn.title = 'Убрать из избранного';
                    showToast('Блюдо добавлено в избранное', 'success');
                }
                
                // Если мы находимся в разделе избранного, перезагружаем данные
                const recipesSection = document.getElementById('recipes-section');
                if (recipesSection && recipesSection.classList.contains('active')) {
                    loadRecipesData(userId);
                }
                
            } catch (error) {
                console.error('Ошибка при работе с избранным:', error);
                showToast('Ошибка при работе с избранным: ' + error.message, 'error');
            }
        }
        
        async function loadRecipesData(userId) {
            console.log('Загрузка меню для пользователя:', userId);
            
            const favoritesListElement = document.getElementById('favorites-list');
            
            // Показываем спиннер загрузки
            favoritesListElement.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка меню...</p>
                </div>
            `;
            
            try {
                // Получаем меню для пользователя
                const menuData = await apiClient.getMenu(userId);
                console.log('Получены данные меню:', menuData);
                
                // Сохраняем данные глобально для фильтрации
                window.favoritesData = menuData.dishes || [];
                window.menuStats = menuData.stats || {};
                window.userTargetCalories = menuData.user_target_calories || 1600;
                window.menuTargetCalories = menuData.menu_target_calories || 1600;
                
                renderMenuDishes(menuData);
                
            } catch (error) {
                console.error('Ошибка при загрузке меню:', error);
                favoritesListElement.innerHTML = `
                    <div class="empty-section">
                        <div class="empty-icon">❌</div>
                        <h5>Ошибка загрузки</h5>
                        <p>Не удалось загрузить меню: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadRecipesData('${userId}')">
                            Попробовать снова
                        </button>
                    </div>
                `;
            }
        }
        
        function renderMenuDishes(menuData) {
            const favoritesListElement = document.getElementById('favorites-list');
            const dishes = menuData.dishes || [];
            
            // Обновляем заголовок раздела с информацией о калориях
            const recipesTitle = document.querySelector('#recipes-section .page-title');
            if (recipesTitle) {
                recipesTitle.innerHTML = `🌟 Избранное <span class="badge bg-primary ms-2" style="font-size: 0.7rem; vertical-align: middle;">Меню ${menuData.menu_target_calories} ккал</span>`;
            }
            
            if (dishes.length === 0) {
                favoritesListElement.innerHTML = `
                    <div class="empty-section">
                        <div class="empty-icon">🍽️</div>
                        <h5>Нет доступных блюд</h5>
                        <p>В меню пока нет блюд для вашей целевой калорийности</p>
                    </div>
                `;
                return;
            }
            
            // Группируем блюда по категориям
            const categorizedDishes = {};
            dishes.forEach(dish => {
                const category = dish.category || 'other';
                if (!categorizedDishes[category]) {
                    categorizedDishes[category] = [];
                }
                categorizedDishes[category].push(dish);
            });
            
            // Создаем HTML для каждой категории
            let html = '';
            
            // Добавляем информацию о меню
            html += `
                <div class="alert alert-info mb-4" role="alert">
                    <h5 class="alert-heading">Меню ${menuData.menu_target_calories} ккал</h5>
                    <p class="mb-0">Блюда подобраны специально для вашей целевой калорийности: ${menuData.user_target_calories} ккал</p>
                </div>
            `;
            
            // Категории в нужном порядке
            const categoryOrder = ['breakfast', 'lunch', 'dinner', 'snack'];
            const categoryNames = {
                'breakfast': '🌅 Завтраки',
                'lunch': '🍽️ Обеды',
                'dinner': '🌙 Ужины',
                'snack': '🥨 Перекусы',
                'other': '📋 Другие блюда'
            };
            
            // Добавляем блюда по категориям
            categoryOrder.forEach(category => {
                if (categorizedDishes[category] && categorizedDishes[category].length > 0) {
                    html += `
                        <div class="card mb-4">
                            <div class="card-header">
                                ${categoryNames[category] || category}
                            </div>
                            <div class="card-body p-0">
                    `;
                    
                    categorizedDishes[category].forEach(dish => {
                        html += `
                            <div class="favorite-item p-3 border-bottom" 
                                 data-id="${dish.id}" 
                                 data-name="${dish.name.toLowerCase()}" 
                                 data-category="${dish.category}" 
                                 data-calories="${dish.calories}" 
                                 data-protein="${dish.protein}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="mb-1">${dish.name}</h5>
                                        <p class="meal-description mb-2">${dish.description}</p>
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-primary me-2">${dish.calories} ккал</span>
                                            <span class="badge bg-secondary me-2">Б: ${dish.protein}г</span>
                                            <span class="badge bg-secondary me-2">Ж: ${dish.fat}г</span>
                                            <span class="badge bg-secondary">У: ${dish.carb}г</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="toggleDishDetails(${dish.id})">
                                        <i class="fas fa-info-circle"></i> Рецепт
                                    </button>
                                    <button class="btn btn-sm btn-success" 
                                            onclick="addDishToDiary('${dish.id}', '${dish.category}')">
                                        <i class="fas fa-plus"></i> Добавить в дневник
                                    </button>
                                </div>
                                
                                <div id="dish-details-${dish.id}" class="dish-details mt-3 p-3 bg-light rounded" style="display: none;">
                                    <h6>Рецепт приготовления:</h6>
                                    <p>${dish.recipe || 'Рецепт не указан'}</p>
                                    <div class="d-flex justify-content-between">
                                        <span><i class="far fa-clock"></i> ${dish.prep_time || '15-30 мин'}</span>
                                        <span><i class="fas fa-utensils"></i> ${dish.difficulty || 'Легко'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            });
            
            favoritesListElement.innerHTML = html;
        }
        function toggleDishDetails(dishId) {
            const detailsElement = document.getElementById(`dish-details-${dishId}`);
            if (detailsElement) {
                detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        async function addDishToDiary(dishId, mealType) {
            try {
                const userId = getUserId();
                console.log(`Добавление блюда ${dishId} в дневник`);
                
                // Определяем тип приема пищи на основе категории блюда
                let diaryMealType = 'lunch'; // По умолчанию обед
                
                if (mealType === 'breakfast') {
                    diaryMealType = 'breakfast';
                } else if (mealType === 'dinner') {
                    diaryMealType = 'dinner';
                } else if (mealType === 'snack') {
                    diaryMealType = 'snack';
                }
                
                // Отправляем запрос на сервер
                const response = await apiClient.addDishToDiary(userId, dishId, diaryMealType);
                
                if (response.status === 'success') {
                    showToast(`Блюдо добавлено в дневник как ${diaryMealType}`, 'success');
                    
                    // Инвалидируем кэш дневника
                    dataCache.delete(`diary_${userId}`);
                    dataCache.delete(`daySummary_${userId}_today`);
                } else {
                    throw new Error('Ошибка при добавлении блюда в дневник');
                }
                
            } catch (error) {
                console.error('Ошибка при добавлении блюда в дневник:', error);
                showToast('Ошибка при добавлении блюда: ' + error.message, 'error');
            }
        }
        
        // Функции фильтрации и сортировки
        function filterFavorites() {
            const searchTerm = document.getElementById('favorites-search').value.toLowerCase();
            const favoriteItems = document.querySelectorAll('.favorite-item');
            
            favoriteItems.forEach(item => {
                const name = item.dataset.name;
                const description = item.querySelector('.meal-description').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function filterByCategory(category) {
            // Обновляем активную кнопку
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-outline-primary');
            });
            
            const activeBtn = document.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-primary');
                activeBtn.classList.add('btn-primary', 'active');
            }
            
            // Фильтруем элементы
            const favoriteItems = document.querySelectorAll('.favorite-item');
            
            favoriteItems.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function sortFavorites() {
            const sortValue = document.getElementById('sort-select').value;
            const favoritesList = document.getElementById('favorites-list');
            const favoriteItems = Array.from(document.querySelectorAll('.favorite-item'));
            
            favoriteItems.sort((a, b) => {
                switch (sortValue) {
                    case 'date-desc':
                        return new Date(b.dataset.date || 0) - new Date(a.dataset.date || 0);
                    case 'date-asc':
                        return new Date(a.dataset.date || 0) - new Date(b.dataset.date || 0);
                    case 'calories-asc':
                        return parseInt(a.dataset.calories) - parseInt(b.dataset.calories);
                    case 'calories-desc':
                        return parseInt(b.dataset.calories) - parseInt(a.dataset.calories);
                    case 'protein-desc':
                        return parseInt(b.dataset.protein) - parseInt(a.dataset.protein);
                    case 'name-asc':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    default:
                        return 0;
                }
            });
            
            // Очищаем контейнер и добавляем отсортированные элементы
            const cardBodies = favoritesList.querySelectorAll('.card-body');
            cardBodies.forEach(cardBody => {
                const category = cardBody.previousElementSibling.textContent.trim();
                const categoryItems = favoriteItems.filter(item => {
                    const itemCategory = item.dataset.category;
                    return (category.includes('Завтраки') && itemCategory === 'breakfast') ||
                           (category.includes('Обеды') && itemCategory === 'lunch') ||
                           (category.includes('Ужины') && itemCategory === 'dinner') ||
                           (category.includes('Перекусы') && itemCategory === 'snack');
                });
                
                cardBody.innerHTML = '';
                categoryItems.forEach(item => cardBody.appendChild(item));
            });
        }
        // Обработчик формы добавления веса
        document.addEventListener('DOMContentLoaded', function() {
            const addWeightForm = document.getElementById('addWeightForm');
            if (addWeightForm) {
                addWeightForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                             class="meal-image" 
                             onclick="showImageModal('${favorite.image}')"
                             title="Нажмите для увеличения">
                    `;
                } else {
                    imageHtml = `
                        <div class="meal-image-placeholder">
                            🍽️
                        </div>
                    `;
                }
                
                // Определяем категорию по времени
                let categoryIcon = '🍽️';
                let categoryName = 'Прием пищи';
                if (favorite.time) {
                    const hour = parseInt(favorite.time.split(':')[0]);
                    if (hour >= 6 && hour < 12) {
                        categoryIcon = '🌅';
                        categoryName = 'Завтрак';
                    } else if (hour >= 12 && hour < 17) {
                        categoryIcon = '🍽️';
                        categoryName = 'Обед';
                    } else if (hour >= 17 && hour < 22) {
                        categoryIcon = '🌙';
                        categoryName = 'Ужин';
                    } else {
                        categoryIcon = '🥨';
                        categoryName = 'Перекус';
                    }
                }
                
                favoritesHtml += `
                    <div class="card mb-3 favorite-item" 
                         data-category="${categoryName.toLowerCase()}" 
                         data-name="${favorite.description.toLowerCase()}"
                         data-calories="${favorite.calories}"
                         data-protein="${favorite.protein}"
                         data-date="${favorite.added_date}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-start" style="flex: 1;">
                                    ${imageHtml}
                                    <div style="flex: 1;">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-primary me-2">${categoryIcon} ${categoryName}</span>
                                            <small class="text-muted">${favorite.time || 'Время не указано'}</small>
                                        </div>
                                        <div class="meal-description mb-2" style="color: #333; font-weight: 500;">${favorite.description}</div>
                                        <div class="nutrition-info" style="font-size: 0.85rem; color: #666;">
                                            ${favorite.calories} ккал • Б: ${favorite.protein}г • Ж: ${favorite.fat}г • У: ${favorite.carb}г
                                        </div>
                                        <small class="text-muted">Добавлено: ${new Date(favorite.added_date).toLocaleDateString('ru-RU')}</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-start" style="gap: 8px;">
                                    <button class="btn btn-sm btn-warning" 
                                            onclick="removeFavorite(${favorite.meal_id})" 
                                            title="Убрать из избранного"
                                            style="min-width: 40px;">
                                        ⭐
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="toggleFavoriteDetails(${favorite.meal_id})">
                                        Детали
                                    </button>
                                </div>
                            </div>
                            <div id="favorite-details-${favorite.meal_id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
                                <h6>Состав:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Продукт</th>
                                                <th>Вес</th>
                                                <th>Калории</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${favorite.products ? favorite.products.map(product => `
                                                <tr>
                                                    <td>${product.name}</td>
                                                    <td>${product.weight}г</td>
                                                    <td>${product.calories} ккал</td>
                                                </tr>
                                            `).join('') : '<tr><td colspan="3">Состав не указан</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            favoritesListElement.innerHTML = favoritesHtml;
        }
        
        async function removeFavorite(mealId) {
            try {
                const userId = getUserId();
                console.log(`Удаление из избранного блюда ${mealId}`);
                
                const response = await fetch(`https://telegram-bot-api-h136.onrender.com/favorites/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ meal_id: mealId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                showToast('Блюдо убрано из избранного', 'success');
                
                // Перезагружаем список избранного
                loadRecipesData(userId);
                
                // Обновляем кнопку в дневнике если она видна
                const favoriteBtn = document.getElementById(`favorite-btn-${mealId}`);
                if (favoriteBtn) {
                    favoriteBtn.classList.remove('btn-warning');
                    favoriteBtn.classList.add('btn-outline-warning');
                    favoriteBtn.innerHTML = '☆';
                    favoriteBtn.title = 'Добавить в избранное';
                }
                
            } catch (error) {
                console.error('Ошибка при удалении из избранного:', error);
                showToast('Ошибка при удалении из избранного: ' + error.message, 'error');
            }
        }
        
        function toggleFavoriteDetails(mealId) {
            const detailsElement = document.getElementById(`favorite-details-${mealId}`);
            if (detailsElement) {
                detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // Функции фильтрации и сортировки
        function filterFavorites() {
            const searchTerm = document.getElementById('favorites-search').value.toLowerCase();
            const favoriteItems = document.querySelectorAll('.favorite-item');
            
            favoriteItems.forEach(item => {
                const name = item.dataset.name;
                const description = item.querySelector('.meal-description').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function filterByCategory(category) {
            // Обновляем активную кнопку
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'active');
                btn.classList.add('btn-outline-primary');
            });
            
            const activeBtn = document.querySelector(`[data-category="${category}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-outline-primary');
                activeBtn.classList.add('btn-primary', 'active');
            }
            
            // Фильтруем элементы
            const favoriteItems = document.querySelectorAll('.favorite-item');
            
            favoriteItems.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function sortFavorites() {
            const sortValue = document.getElementById('sort-select').value;
            const favoritesList = document.getElementById('favorites-list');
            const favoriteItems = Array.from(document.querySelectorAll('.favorite-item'));
            
            favoriteItems.sort((a, b) => {
                switch (sortValue) {
                    case 'date-desc':
                        return new Date(b.dataset.date) - new Date(a.dataset.date);
                    case 'date-asc':
                        return new Date(a.dataset.date) - new Date(b.dataset.date);
                    case 'calories-asc':
                        return parseInt(a.dataset.calories) - parseInt(b.dataset.calories);
                    case 'calories-desc':
                        return parseInt(b.dataset.calories) - parseInt(a.dataset.calories);
                    case 'protein-desc':
                        return parseInt(b.dataset.protein) - parseInt(a.dataset.protein);
                    case 'name-asc':
                        return a.dataset.name.localeCompare(b.dataset.name);
                    default:
                        return 0;
                }
            });
            
            // Очищаем контейнер и добавляем отсортированные элементы
            favoritesList.innerHTML = '';
            favoriteItems.forEach(item => favoritesList.appendChild(item));
        }
        
        // Обработчик формы добавления весаа
        document.addEventListener('DOMContentLoaded', function() {
            const addWeightForm = document.getElementById('addWeightForm');
            if (addWeightForm) {
                addWeightForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const weight = document.getElementById('weightInput').value;
                    
                    if (weight && weight > 0) {
                        // Отключаем кнопку чтобы избежать дублирования
                        const submitBtn = this.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Сохранение...';
                        
                        addWeight(getUserId(), weight, '').finally(() => {
                            // Восстанавливаем кнопку
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                            // Очищаем форму
                            document.getElementById('weightInput').value = '';
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>

